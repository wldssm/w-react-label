"use strict";(self.webpackChunkw_react_label=self.webpackChunkw_react_label||[]).push([[970],{28970:function(ze,$r,q){q.r($r),q.d($r,{WColorBlock:function(){return xt},WDraw:function(){return Ft},WShapeList:function(){return Wt}});var wt=q(5574),K=q.n(wt),J=q(67294),br=q(85893),_r=function(F){var d=F.colorBlocks,T=(0,J.useState)(d[0]),b=K()(T,2),D=b[0],o=b[1];(0,J.useEffect)(function(){F.color&&o(F.color)},[]);var E=function(Y,O){o(Y),F.onChange&&F.onChange(Y,O)};return(0,br.jsx)("div",{className:"w-color-block-box",children:d.map(function(B,Y){return(0,br.jsx)("div",{onClick:function(j){return E(B,j)},className:"w-color-block ".concat(B===D?"on":""),style:{background:B}},Y)})})};_r.defaultProps={color:"",colorBlocks:["#f00","#FFA500","#ff0","#0f0","#0ff","#00f","#800080","#fff"],onChange:function(){}};var xt=_r,Ct=q(9783),Jr=q.n(Ct),Et=q(97857),gr=q.n(Et),Ot=q(13769),rt=q.n(Ot),Pt=q(52677),Yt=q.n(Pt),Lt=q(19632),er=q.n(Lt),Rt=q(61227),kt=q.n(Rt),g=q(46886),k={color:["#CB3D45","#DA833C","#2378DE"],svg:{width:800,height:600},shapeCommon:{fill:"rgba(0, 0, 0, 0)",stroke:"#CB3D45","stroke-width":2,"vector-effect":"non-scaling-stroke"},rect:{x:0,y:0,width:0,height:0},selectBox:{"stroke-width":1,fill:"rgb(34 34 204 / 12%)",stroke:"rgb(34 34 204 / 45%)","vector-effect":"non-scaling-stroke"},ellipse:{cx:0,cy:0,rx:0,ry:0},path:{d:""},line:{d:"",fill:"none",stroke:"#00f","stroke-width":1},point:{cx:0,cy:0,r:4,fill:"rgba(0,0,255,.45)",stroke:"rgba(0, 0, 0, 0)","stroke-width":10},grip:{width:8,height:8,fill:"rgba(0,0,255,.45)",stroke:"rgba(0, 0, 0, 0)","stroke-width":10},font:{x:0,y:0,fill:"#CB3D45",stroke:"none","font-size":16,"text-anchor":"start","dominant-baseline":"text-after-edge"},pathAddPoint:{fill:"none",stroke:"rgba(0,0,0,0)","stroke-width":25},rotateLine:{x1:0,y1:0,x2:0,y2:0,fill:"rgba(0,0,255,.45)"},rotateCircle:{cx:0,cy:0,r:5,fill:"rgba(0,0,255,.45)",stroke:"rgba(0, 0, 0, 0)","stroke-width":6}},Dt=["128, 0, 0","0, 128, 0","128, 128, 0","0, 0, 128","128, 0, 128","0, 128, 128","128, 128, 128","64, 0, 0","192, 0, 0","64, 128, 0","192, 128, 0","64, 0, 128","192, 0, 128","64, 128, 128","192, 128, 128","0, 64, 0","128, 64, 0","0, 192, 0","128, 192, 0","0, 64, 128","128, 64, 128","0, 192, 128","128, 192, 128","64, 64, 0","192, 64, 0","64, 192, 0","192, 192, 0","64, 64, 128","192, 64, 128","64, 192, 128","192, 192, 128","0, 0, 64","128, 0, 64","0, 128, 64","128, 128, 64","0, 0, 192","128, 0, 192","0, 128, 192","128, 128, 192","64, 0, 64","192, 0, 64","64, 128, 64","192, 128, 64","64, 0, 192","192, 0, 192","64, 128, 192","192, 128, 192","0, 64, 64","128, 64, 64","0, 192, 64","128, 192, 64","0, 64, 192","128, 64, 192","0, 192, 192","128, 192, 192","64, 64, 64","192, 64, 64","64, 192, 64","192, 192, 64","64, 64, 192","192, 64, 192","64, 192, 192","192, 192, 192","32, 0, 0","160, 0, 0","32, 128, 0","160, 128, 0","32, 0, 128","160, 0, 128","32, 128, 128","160, 128, 128","96, 0, 0","224, 0, 0","96, 128, 0","224, 128, 0","96, 0, 128","224, 0, 128","96, 128, 128","224, 128, 128","32, 64, 0","160, 64, 0","32, 192, 0","160, 192, 0","32, 64, 128","160, 64, 128","32, 192, 128","160, 192, 128","96, 64, 0","224, 64, 0","96, 192, 0","224, 192, 0","96, 64, 128","224, 64, 128","96, 192, 128","224, 192, 128","32, 0, 64","160, 0, 64","32, 128, 64","160, 128, 64","32, 0, 192","160, 0, 192","32, 128, 192","160, 128, 192","96, 0, 64","224, 0, 64","96, 128, 64","224, 128, 64","96, 0, 192","224, 0, 192","96, 128, 192","224, 128, 192","32, 64, 64","160, 64, 64","32, 192, 64","160, 192, 64","32, 64, 192","160, 64, 192","32, 192, 192","160, 192, 192","96, 64, 64","224, 64, 64","96, 192, 64","224, 192, 64","96, 64, 192","224, 64, 192","96, 192, 192","224, 192, 192","0, 32, 0","128, 32, 0","0, 160, 0","128, 160, 0","0, 32, 128","128, 32, 128","0, 160, 128","128, 160, 128","64, 32, 0","192, 32, 0","64, 160, 0","192, 160, 0","64, 32, 128","192, 32, 128","64, 160, 128","192, 160, 128","0, 96, 0","128, 96, 0","0, 224, 0","128, 224, 0","0, 96, 128","128, 96, 128","0, 224, 128","128, 224, 128","64, 96, 0","192, 96, 0","64, 224, 0","192, 224, 0","64, 96, 128","192, 96, 128","64, 224, 128","192, 224, 128","0, 32, 64","128, 32, 64","0, 160, 64","128, 160, 64","0, 32, 192","128, 32, 192","0, 160, 192","128, 160, 192","64, 32, 64","192, 32, 64","64, 160, 64","192, 160, 64","64, 32, 192","192, 32, 192","64, 160, 192","192, 160, 192","0, 96, 64","128, 96, 64","0, 224, 64","128, 224, 64","0, 96, 192","128, 96, 192","0, 224, 192","128, 224, 192","64, 96, 64","192, 96, 64","64, 224, 64","192, 224, 64","64, 96, 192","192, 96, 192","64, 224, 192","192, 224, 192","32, 32, 0","160, 32, 0","32, 160, 0","160, 160, 0","32, 32, 128","160, 32, 128","32, 160, 128","160, 160, 128","96, 32, 0","224, 32, 0","96, 160, 0","224, 160, 0","96, 32, 128","224, 32, 128","96, 160, 128","224, 160, 128","32, 96, 0","160, 96, 0","32, 224, 0","160, 224, 0","32, 96, 128","160, 96, 128","32, 224, 128","160, 224, 128","96, 96, 0","224, 96, 0","96, 224, 0","224, 224, 0","96, 96, 128","224, 96, 128","96, 224, 128","224, 224, 128","32, 32, 64","160, 32, 64","32, 160, 64","160, 160, 64","32, 32, 192","160, 32, 192","32, 160, 192","160, 160, 192","96, 32, 64","224, 32, 64","96, 160, 64","224, 160, 64","96, 32, 192","224, 32, 192","96, 160, 192","224, 160, 192","32, 96, 64","160, 96, 64","32, 224, 64","160, 224, 64","32, 96, 192","160, 96, 192","32, 224, 192","160, 224, 192","96, 96, 64","224, 96, 64","96, 224, 64","224, 224, 64","96, 96, 192","224, 96, 192","96, 224, 192","224, 224, 192","0,0,0"],tt=function(F){var d=Object.keys(F).length;return"rgb("+Dt[d]+")"},et=["n","ne","e","se","s","sw","w","nw"],jt=function(F){return!!(F.touches&&F.touches.length)},Bt=function(F,d){for(var T=arguments.length,b=new Array(T>2?T-2:0),D=2;D<T;D++)b[D-2]=arguments[D];var o={},E=b[0],B=b[1],Y=b[2],O=b[3];if(F==="rect"){if(o=zt.apply(void 0,b),d){var j=O.width,w=O.height,R=o.width-o.height,W=E.indexOf("n")>=0&&Y<=w||E.indexOf("s")>=0&&Y<=-w,H=E.indexOf("e")>=0&&B<=-j||E.indexOf("w")>=0&&B<=j;R>0?(W&&(o.y=o.y-R),o.height=o.width):(H&&(o.x=o.x+R),o.width=o.height)}}else if(F==="ellipse"){if(o=At.apply(void 0,b),d){var Z=O.rx,I=O.ry,$=o.rx-o.ry,or=E.indexOf("n")>=0&&Y<=I*2||E.indexOf("s")>=0&&Y<=-I*2,x=E.indexOf("e")>=0&&B<=-Z*2||E.indexOf("w")>=0&&B<=Z*2;$>0?(or&&($=-$),o.ry=o.rx,o.cy=o.cy+$):(x&&($=-$),o.cx=o.cx-$,o.rx=o.ry)}}else o=Jt.apply(void 0,[d].concat(b));return o},zt=function(){for(var F=arguments.length,d=new Array(F),T=0;T<F;T++)d[T]=arguments[T];var b=d[0],D=d[1],o=d[2],E=d[3],B=E.x,Y=E.y,O=E.width,j=E.height,w=O,R=j;return b.indexOf("n")>=0?(R=j-o,R>0?Y=Y+o:Y=Y+j,R=Math.abs(R)):b.indexOf("s")>=0&&(R=j+o,R<0&&(Y=Y+j+o),R=Math.abs(R)),b.indexOf("w")>=0?(w=O-D,w<0?B=B+O:B=B+D,w=Math.abs(w)):b.indexOf("e")>=0&&(w=O+D,w<0&&(B=B+O+D),w=Math.abs(w)),{x:B,y:Y,width:w,height:R}},At=function(){for(var F=arguments.length,d=new Array(F),T=0;T<F;T++)d[T]=arguments[T];var b=d[0],D=d[1],o=d[2],E=d[3],B=E.cx,Y=E.cy,O=E.rx,j=E.ry;return D=D/2,o=o/2,b.indexOf("n")>=0?(j=j-o,Y=Y+o,j=Math.abs(j)):b.indexOf("s")>=0&&(j=j+o,Y=Y+o,j=Math.abs(j)),b.indexOf("w")>=0?(O=O-D,B=B+D,O=Math.abs(O)):b.indexOf("e")>=0&&(O=O+D,B=B+D,O=Math.abs(O)),{cx:B,cy:Y,rx:O,ry:j}},Jt=function(F){for(var d=arguments.length,T=new Array(d>1?d-1:0),b=1;b<d;b++)T[b-1]=arguments[b];var D=T[0],o=T[1],E=T[2],B=T[3],Y=B.points,O=B.boundRect,j=(Y==null?void 0:Y.length)||0,w=[],R=O.x,W=O.y,H=O.width,Z=O.height,I=H/Z,$=D.indexOf("n")>=0,or=D.indexOf("s")>=0,x=D.indexOf("w")>=0,yr=D.indexOf("e")>=0,wr="";F&&(D.length===1?($||or?(o=E*I,wr="v"):(E=o/I,wr="h"),$?o=-o:x&&(E=-E)):(E=o/I,(x&&or||yr&&$)&&(E=-E)));for(var ar=0;ar<j;ar++){var N=er()(Y[ar]),z=Math.abs(N[0]-R)/H,m=Math.abs(N[1]-W)/Z;$&&(N[1]+=E*(1-m)),(or||wr==="h")&&(N[1]+=E*m),x&&(N[0]+=o*(1-z)),(yr||wr==="v")&&(N[0]+=o*z),w.push(N)}return{points:w}},Mt=function(F,d,T){var b=K()(F,2),D=b[0],o=b[1],E=K()(d,2),B=E[0],Y=E[1],O=K()(T,2),j=O[0],w=O[1],R=j-B,W=w-Y,H=((D-B)*R+(o-Y)*W)/(R*R+W*W);return H<0?(R=D-B,W=o-Y):H>1?(R=D-j,W=o-w):(R=D-(B+H*R),W=o-(Y+H*W)),Math.sqrt(R*R+W*W)},Nt=["attrs","shape_type"],Tt=["points","shape_type"],nt=(0,J.forwardRef)(function(M,F){var d=(0,J.useRef)(M),T=(0,J.useRef)(null),b=(0,J.useRef)(null),D=(0,J.useRef)(null),o=(0,J.useRef)(null),E=(0,J.useRef)(null),B=(0,J.useRef)(null),Y=(0,J.useRef)(""),O=(0,J.useRef)(null),j=(0,J.useRef)(null),w=(0,J.useRef)(null),R=(0,J.useRef)({x:0,y:0,w:0,h:0,mx:0,my:0}),W=(0,J.useRef)(!1),H=(0,J.useRef)(!1),Z=(0,J.useRef)(!1),I=(0,J.useRef)([]),$=(0,J.useRef)("1"),or=(0,J.useRef)({x:0,y:0,scale:1,w:0,h:0}),x=(0,J.useRef)(null),yr=(0,J.useRef)(null),wr=(0,J.useRef)(""),ar=(0,J.useRef)(!1),N=(0,J.useRef)(!1),z=(0,J.useRef)(!1),m=(0,J.useRef)({}),U=(0,J.useRef)(null),P=(0,J.useRef)({}),_=(0,J.useRef)([]),rr=(0,J.useRef)([]),V=function(){var r;(r=g.td_("#shape-grip-group,#path-point-group *,#shape-path-group *,#path-add-point"))===null||r===void 0||r.attr("display","none"),B.current="",E.current&&(g.Ys("#"+E.current).attr("fill",k.shapeCommon.fill),E.current=""),Y.current&&(g.Ys("#"+Y.current).attr("fill",k.grip.fill),Y.current=""),O.current&&(g.Ys("#path-point-"+O.current).attr("fill",k.point.fill),O.current="")},Pr=function(){if(document.getElementById("svgcanvas")!==document.activeElement){var r;(r=document.getElementById("svgcanvas"))===null||r===void 0||r.focus()}},ir=function(r){var t=(r==null?void 0:r.sourceEvent)||r,e=[];if(jt(t)?e=g.cx$(t.touches[0]||t.changedTouches[0],b.current.node()):e=g.cx$(t,b.current.node()),w.current){var n=w.current,a=n.x,u=n.y,c=n.k;e[0]=(e[0]-a)/c,e[1]=(e[1]-u)/c}return e},mr=function(){for(var r=I.current.length||0,t=0,e=0;e<r;e++)if(+I.current[e]!==e+1){t=e+1;break}return t===0&&(t=r+1),t=""+t,I.current.splice(t-1,0,t),t},Dr=function(r){return r==="ellipse"?{x:"cx",y:"cy",w:"rx",h:"ry"}:{x:"x",y:"y",w:"width",h:"height"}},It=function(){var r=d.current.drawTool,t=M.minSize,e=0,n=0;return r==="rect"?(e=o.current.attr("width"),n=o.current.attr("height")):r==="ellipse"&&(e=o.current.attr("rx")*2||0,n=o.current.attr("ry")*2||0),+e<=t[0]||+n<=t[1]?(o.current.remove(),o.current=null,g.Ys("#shape-grip-group").attr("display","none"),!0):!1},Yr=function(){var r,t,e,n,a;if(!o.current||H.current||B.current)return!1;var u=(r=o.current.attr("id"))===null||r===void 0?void 0:r.substring(6),c=((t=m.current)===null||t===void 0?void 0:t[u])||!1,i=c.hide;if(g.Ys("#shape-grip-group").attr("display",i?"none":"inline"),!i){var l=(w==null||(e=w.current)===null||e===void 0?void 0:e.k)||1,s=(n=o.current)===null||n===void 0||(a=n.node())===null||a===void 0?void 0:a.getBBox(),f=s.x,h=s.y,v=s.width,p=s.height,S=k.grip.width/2,C=k.grip.height/2;f=f*l||0,h=h*l||0,v=v*l||0,p=p*l||0;var L=[[f,h],[f+v,h],[f+v,h+p],[f,h+p]],A=j.current(L);if(g.Ys("#resize-path").attr("d",A+"Z"),d.current.rotateEnable){var G=f+v/2;g.Ys("#rotate-line").attr("x1",G).attr("y1",h-4).attr("x2",G).attr("y2",h-16),g.Ys("#rotate-circle").attr("cx",G).attr("cy",h-20)}g.Ys("#resize-grip-nw").attr("x",f-S).attr("y",h-C),g.Ys("#resize-grip-n").attr("x",f+v/2-S).attr("y",h-C),g.Ys("#resize-grip-ne").attr("x",f+v-S).attr("y",h-C),g.Ys("#resize-grip-w").attr("x",f-S).attr("y",h+p/2-C),g.Ys("#resize-grip-e").attr("x",f+v-S).attr("y",h+p/2-C),g.Ys("#resize-grip-sw").attr("x",f-S).attr("y",h+p-C),g.Ys("#resize-grip-s").attr("x",f+v/2-S).attr("y",h+p-C),g.Ys("#resize-grip-se").attr("x",f+v-S).attr("y",h+p-C)}},it=function(r){var t,e;if(!U.current){for(var n=(t=m.current)===null||t===void 0?void 0:t[r],a=n.attrs.points,u=n.shape_type,c=a.length,i=(w==null||(e=w.current)===null||e===void 0?void 0:e.k)||1,l=[],s=0;s<c;s++){var f=K()(a[s],2),h=f[0],v=f[1];h=h*i,v=v*i,l[s]=[h,v]}var p=j.current(l);u==="polygon"&&(p+="Z"),b.current.select("#path-add-point").attr("d",p)}},Kr=function(r){var t,e=U.current||[],n=e.length;if(!(!H.current||!n)){var a=(w==null||(t=w.current)===null||t===void 0?void 0:t.k)||1,u=K()(e[n-1],2),c=u[0],i=u[1],l=ir(r),s=K()(l,2),f=s[0],h=s[1];c=c*a,i=i*a,f=f*a,h=h*a;var v=[[c,i],[f,h]],p=j.current(v);g.Ys("#path-stretch-line").attr("d",p)}},Er=function(r){var t,e,n,a,u;if(!o.current||!o.current.attr("id"))return!1;var c=(t=o.current.attr("id"))===null||t===void 0?void 0:t.substring(6),i=((e=m.current)===null||e===void 0||(n=e[c])===null||n===void 0||(a=n.attrs)===null||a===void 0?void 0:a.points)||U.current||[],l=i.length,s=(w==null||(u=w.current)===null||u===void 0?void 0:u.k)||1;if(l){it(c);for(var f=0;f<l;f++){var h=g.Ys("#path-point-group #path-point-".concat(f+1)),v=K()(i[f],2),p=v[0],S=v[1];p=p*s,S=S*s,h.attr("cx",p).attr("cy",S).attr("display","inline")}r&&Kr(r)}},Mr=function(r){var t=r?M.showGrid:d.current.showGrid;if(t)if(w.current=w.current||g.CRH,w.current.k<1)b.current.select("#grid").attr("display","none");else{var e=or.current,n=e.x,a=e.y,u=e.w,c=e.h,i=w.current.k,l=10*i,s=n*i,f=a*i;b.current.select("#gridPattern").attr("width",l).attr("height",l).attr("x",s).attr("y",f),b.current.select("#grid").attr("display","inline").attr("x",s).attr("y",f).attr("width",u*i).attr("height",c*i)}},Nr=function(r){var t=d.current,e=t.curLabel,n=t.colorBindLabel,a=r||e;if(n){var u=P.current[a]||tt(P.current);k.shapeCommon.stroke=u,k.font.fill=u,r&&(P.current[a]=u)}},Tr=function(r){var t=r||k.shapeCommon.stroke;return g.$_Y(t).copy({opacity:.2})},Fr=function(r,t){var e=g.Ys("#shape-".concat(r));e.attr("stroke",t),d.current.showLabel&&b.current.select("#shape-label-".concat(r)).attr("fill",t),E.current==="shape-"+r&&e.attr("fill",Tr(t))},Kt=function(r){var t,e=d.current,n=e.colorBindLabel,a=e.curLabel;if(n){var u,c,i;if(x.current||!o.current)return;var l=(u=o.current.attr("id"))===null||u===void 0?void 0:u.substring(6),s=(c=m.current)===null||c===void 0?void 0:c[l],f=s.label,h=P.current[a];(i=Object.keys(m.current))===null||i===void 0||i.forEach(function(S){var C=m.current[S].label;C===f&&Fr(S,r)}),h&&(k.shapeCommon.stroke=h,k.font.fill=h),P.current[f]=r,d.current.changeBindColor(P.current);return}if(k.shapeCommon.stroke=r,k.font.fill=r,x.current){var v;(v=x.current)===null||v===void 0||v.forEach(function(S){Fr(S,r)});return}if(o.current){var p=(t=o.current.attr("id"))===null||t===void 0?void 0:t.substring(6);Fr(p,r)}},Lr=function(r,t,e){var n;if(t){var a=(w==null||(n=w.current)===null||n===void 0?void 0:n.k)||1,u=m.current[r],c=u.shape_type,i=u.attrs,l=b.current.select("#shape-label-".concat(r)),s=0,f=0;if(c==="ellipse"){var h=i.cx,v=i.cy,p=i.ry;s=h,f=v-p}else if(c==="rect")s=i.x,f=i.y;else{var S=i.points,C=K()(S[0],2);s=C[0],f=C[1];for(var L=1;L<S.length;L++){var A=K()(S[L],2),G=A[0],X=A[1];f>X?(f=X,s=G):f===X&&s>G&&(s=G)}}s=s*a||0,f=f*a||0,l.attr("x",s).attr("y",f),e&&l.attr("fill",k.font.fill)}},Zr=function(r){var t=r?M.showLabel:d.current.showLabel;if(t){var e=Object.keys(m.current);e==null||e.forEach(function(n){Lr(n,t)})}},sr=function(){for(var r=arguments.length,t=new Array(r),e=0;e<r;e++)t[e]=arguments[e];_.current.push(t),rr.current=[]},Wr=function(){var r=[],t={};if(x.current){var e,n={};(e=x.current)===null||e===void 0||e.forEach(function(i){var l=g.Ys("#shape-".concat(i));t[i]=JSON.parse(JSON.stringify(m.current[i])),n[i]=l}),r=[x.current,t,n]}else if(o.current){var a,u,c=(a=o.current)===null||a===void 0||(u=a.attr("id"))===null||u===void 0?void 0:u.substring(6);t[c]=JSON.parse(JSON.stringify(m.current[c])),r=[o.current,t]}return r},Gr=function(r){var t,e,n,a=(t=o.current)===null||t===void 0||(e=t.attr("id"))===null||e===void 0?void 0:e.substring(6),u=(n=m.current)===null||n===void 0?void 0:n[a],c=u.attrs,i=u.shape_type;if(R.current=c,i==="polygon"||i==="line"){var l,s;R.current.boundRect=(l=o.current)===null||l===void 0||(s=l.node())===null||s===void 0?void 0:s.getBBox(),R.current.close=i==="polygon"}var f=ir(r),h=K()(f,2);R.current.mx=h[0],R.current.my=h[1]},cr=function(){var r=Object.keys(m.current),t=[],e=or.current,n=e.x,a=e.y,u=e.scale;return r==null||r.forEach(function(c){var i=m.current[c],l=i.attrs,s=i.label,f=i.shape_type,h=i.hide,v={};if(v.label=s||c,v.shape_type=f,v.attrs={},v.hide=h||!1,v.id=c,f==="rect")v.attrs.x=(l.x-n)*u,v.attrs.y=(l.y-a)*u,v.attrs.width=l.width*u,v.attrs.height=l.height*u;else if(f==="ellipse")v.attrs.cx=(l.cx-n)*u,v.attrs.cy=(l.cy-a)*u,v.attrs.rx=l.rx*u,v.attrs.ry=l.ry*u;else{var p;v.attrs.points=[],(p=l.points)===null||p===void 0||p.forEach(function(S,C){v.attrs.points[C]=[(S[0]-n)*u,(S[1]-a)*u]})}t.push(v)}),t},Zt=function(r){var t=(r==null?void 0:r.target)||(r==null?void 0:r.srcElement),e=g.Ys(t).attr("id"),n=null,a=d.current.drawTool;Y.current||O.current?n="crosshair":ar.current&&!N.current&&!z.current||a==="drag"?n="grab":e==="path-add-point"?n="pointer":o.current&&!H.current&&E.current===e||x.current&&x.current.includes(e==null?void 0:e.substring(6))?n="move":(!a||a==="move")&&(n="default"),g.Ys(T.current).style("cursor",n)},Gt=function(r){d.current.showCrosshair&&(b.current.select("#crosshair-v-line").attr("x",r.layerX),b.current.select("#crosshair-h-line").attr("y",r.layerY))},Hr=function(r){var t=g.Ys("#shape-path-group #shape-path-".concat(r));if(t.node())t.attr("display","inline");else{t=g.Ys("#shape-path-group").append("path").attr("id","shape-path-".concat(r)).style("pointer-events","none");var e=k.line;Object.keys(e).forEach(function(n){t.attr(n,e[n])})}return t},jr=function(){var r,t,e=(w==null||(r=w.current)===null||r===void 0?void 0:r.k)||1;(t=x.current)===null||t===void 0||t.forEach(function(n,a){var u=g.Ys("#shape-".concat(n)),c=u.node().getBBox(),i=c.x,l=c.y,s=c.width,f=c.height,h=Hr(a);i=i*e||0,l=l*e||0,s=s*e||0,f=f*e||0;var v=[[i-2,l-2],[i+s+2,l-2],[i+s+2,l+f+2],[i-2,l+f+2]],p=j.current(v);h.attr("d",p+"Z")})},dr=function(){var r,t,e;return(r=x.current)!==null&&r!==void 0&&r.length?x.current:o.current?[(t=o.current)===null||t===void 0||(e=t.attr("id"))===null||e===void 0?void 0:e.substring(6)]:[]},Ur=function(r,t){var e,n,a,u=t,c=r,i="",l="";if(c instanceof Array)x.current=c,u=!0;else if(typeof c=="string")i="shape-"+c,c=b.current.select("#".concat(i));else{var s,f;i=(s=c)===null||s===void 0?void 0:s.attr("id"),l=(f=o.current)===null||f===void 0?void 0:f.attr("id")}if(u&&(l&&i!==l||x.current)){var h,v;if(o.current=null,i=(h=i)===null||h===void 0?void 0:h.substring(6),x.current)if(i){var S=x.current.indexOf(i);if(S>=0){var C;x.current.splice(S,1),(C=x.current)!==null&&C!==void 0&&C.length||(x.current=null)}else x.current.push(i);d.current.changeSelect(dr())}else d.current.changeSelect(dr());else{var p;l=(p=l)===null||p===void 0?void 0:p.substring(6),x.current=[i,l],d.current.changeSelect(dr())}(v=x.current)===null||v===void 0||v.forEach(function(ur,tr){Hr(tr)}),V(),jr();return}o.current=c,(e=g.td_("#shape-path-group *"))===null||e===void 0||e.attr("display","none"),x.current=null;var L=(n=m.current)===null||n===void 0?void 0:n[(a=i)===null||a===void 0?void 0:a.substring(6)],A=L.shape_type,G=L.hide;if(E.current&&g.Ys("#"+E.current).attr("fill",k.shapeCommon.fill),E.current===i)E.current="",(A==="line"||A==="polygon")&&(B.current="",b.current.selectAll("#path-point-group circle,#path-add-point").attr("display","none"),Yr());else if(E.current!==i)if(E.current=i,c.attr("fill",Tr(c.attr("stroke"))),A==="line"||A==="polygon"){var X;if(B.current=i,(X=g.td_("#shape-grip-group"))===null||X===void 0||X.attr("display","none"),G)g.td_("#path-point-group circle,#path-add-point").attr("display","none");else{var Q;(Q=b.current.select("#path-add-point"))===null||Q===void 0||Q.attr("display","inline"),Er()}}else B.current="",b.current.selectAll("#path-point-group circle,#path-add-point").attr("display","none"),Yr();d.current.changeSelect(dr())},kr=function(r){var t,e,n,a=r||o.current;if(a){V();var u=(t=a.attr("id"))===null||t===void 0?void 0:t.substring(6),c=I.current.indexOf(u);I.current.splice(c,1),a==null||a.remove(),(e=b.current.select("#shape-label-".concat(u)))===null||e===void 0||e.attr("display","none"),o.current=null,U.current=null,(n=m.current)===null||n===void 0||delete n[u]}},Xr=function(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,e={};if(x.current){var n,a={};return(n=x.current)===null||n===void 0||n.forEach(function(c){var i=g.Ys("#shape-".concat(c));e[c]=JSON.parse(JSON.stringify(m.current[c])),a[c]=i,kr(i)}),t&&sr("del",x.current,e,a),x.current=null,d.current.changeSize(cr()),d.current.changeSelect(dr()),[e,a]}if(o.current){var u=(r=o.current.attr("id"))===null||r===void 0?void 0:r.substring(6);return e[u]=JSON.parse(JSON.stringify(m.current[u])),t&&sr("del",o.current,e),kr(),d.current.changeSize(cr()),d.current.changeSelect(dr()),[e]}},Ht=function(){var r,t;if(!(!O.current||!o.current)){var e=(r=o.current.attr("id"))===null||r===void 0?void 0:r.substring(6),n=((t=m.current)===null||t===void 0?void 0:t[e])||{},a=n.attrs.points,u=n.shape_type,c=a.length,i={};if(i[e]=JSON.parse(JSON.stringify(m.current[e])),c<=2){sr("del",o.current,i),kr(),V();return}sr("edit",o.current,i),g.Ys("#path-point-group #path-point-".concat(c)).attr("display","none"),g.Ys("#path-point-group #path-point-".concat(O.current)).attr("fill",k.point.fill),a.splice(O.current-1,1),O.current=null;var l=j.current(a);u==="polygon"&&(l+="Z"),o.current.attr("d",l),Lr(e,d.current.showLabel),Er()}},ct=function(r,t){var e=t.shape_type,n=t.attrs;if(e==="rect"||e==="ellipse"){var a=Object.keys(n);a==null||a.forEach(function(i){r.attr(i,n[i])})}else{var u=n.points,c=j.current(u);e==="polygon"&&(c+="Z"),r.attr("d",c)}},ut=function(r){var t=r||[],e=kt()(t),n=e[0],a=e.slice(1),u=K()(a,3),c=u[0],i=u[1],l=u[2],s=[];if(n==="add")c instanceof Array?x.current=c:(x.current=null,o.current=c),s=Xr(!1);else if(n==="del"){if(c instanceof Array)c==null||c.forEach(function(A){var G;I.current.splice(A-1,0,+A),(G=b.current.select("#shape-label-".concat(A)))===null||G===void 0||G.attr("display","inline"),b.current.select("#shape").insert(function(){return l[A].node()})});else{var f,h,v=(f=Object.keys(i))===null||f===void 0?void 0:f[0];I.current.splice(v-1,0,v),(h=b.current.select("#shape-label-".concat(v)))===null||h===void 0||h.attr("display","inline"),b.current.select("#shape").insert(function(){return c.node()})}m.current=Object.assign({},m.current,i)}else if(n==="edit"){var p={};if(c instanceof Array)c==null||c.forEach(function(A){p[A]=JSON.parse(JSON.stringify(m.current[A])),ct(l[A],i[A])}),s=[p,l];else{var S,C,L=(S=c.attr("id"))===null||S===void 0?void 0:S.substring(6);p[L]=JSON.parse(JSON.stringify(m.current[L])),ct(c,(C=Object.values(i))===null||C===void 0?void 0:C[0]),s=[p]}m.current=Object.assign({},m.current,i)}return x.current=null,o.current=null,d.current.changeSize(cr()),d.current.changeSelect([]),V(),Zr(),n==="del"?[c]:[c].concat(er()(s))},Ut=function(){if(_.current.length){var r=_.current.pop(),t=r||[],e=K()(t,1),n=e[0],a=ut(r);if(n==="add"){rr.current.push(["del"].concat(er()(a)));return}else n==="del"?rr.current.push(["add"].concat(er()(a))):n==="edit"&&rr.current.push([n].concat(er()(a)))}},Xt=function(){if(rr.current.length){var r=rr.current.pop(),t=r||[],e=K()(t,1),n=e[0],a=ut(r);if(n==="add")_.current.push(["del"].concat(er()(a)));else if(n==="del"){_.current.push(["add"].concat(er()(a)));return}else n==="edit"&&_.current.push([n].concat(er()(a)))}},lt=function(r,t,e){var n,a=e||o.current;if(a){var u=d.current.showLabel,c=K()(r,2),i=c[0],l=c[1],s=a==null||(n=a.attr("id"))===null||n===void 0?void 0:n.substring(6),f=m.current[s],h=f.attrs,v=f.shape_type,p={};if(v==="rect"){var S=h.x,C=h.y,L=h.width,A=h.height;S+=i,C+=l,a.attr("x",S).attr("y",C),p={x:S,y:C,width:L,height:A}}else if(v==="ellipse"){var G=h.cx,X=h.cy,Q=h.rx,ur=h.ry;G+=i,X+=l,a.attr("cx",G).attr("cy",X),p={cx:G,cy:X,rx:Q,ry:ur}}else{for(var tr=h.points,hr=v==="polygon",nr=(tr==null?void 0:tr.length)||0,lr=[],fr=0;fr<nr;fr++){var vr=K()(tr[fr],2),Cr=vr[0],pr=vr[1];Cr+=i,pr+=l,lr[fr]=[Cr,pr]}var Rr=j.current(lr);a.attr("d",Rr+(hr?"Z":"")),p={points:lr},lr=null}m.current[s].attrs=p,x.current?jr():v==="rect"||v==="ellipse"?Yr():Er(t),Lr(s,u)}},ot=function(r,t){if(x.current){var e;(e=x.current)===null||e===void 0||e.forEach(function(n){var a=g.Ys("#shape-".concat(n));lt(r,t,a)});return}lt(r,t)},Ir=function(r,t,e){var n=b.current.select("#shape-label-".concat(r)),a=d.current.showLabel;if(n.node()){n.text(t).attr("display","inline"),Lr(r,a,!0);return}var u=b.current.select("#shape-label-group").append("text").attr("id","shape-label-".concat(r)).style("user-select","none").text(t),c=Object.assign({},k.font);e&&(c["text-anchor"]="middle"),Object.keys(c).forEach(function(i){u.attr(i,c[i])}),Lr(r,a)},Sr=function(r){for(var t=arguments.length,e=new Array(t>1?t-1:0),n=1;n<t;n++)e[n-1]=arguments[n];var a=e[0],u=e[1],c=ir(a),i=c[0]-R.current.mx,l=c[1]-R.current.my;if(r==="moveGrip"){var s,f,h,v="",p=(s=o.current)===null||s===void 0||(f=s.attr("id"))===null||f===void 0?void 0:f.substring(6),S=(h=m.current)===null||h===void 0?void 0:h[p],C=S.shape_type;Y.current?v=Y.current.substring(12):v=u.attr("id").substring(12);var L=Bt(C,N.current,v,i,l,R.current);if(C==="polygon"||C==="line"){var A=j.current(L.points);o.current.attr("d",A+(R.current.close?"Z":""))}else Object.keys(L).forEach(function(pr){o.current.attr(pr,L[pr])});m.current[p].attrs=L,Yr(),Lr(p,d.current.showLabel);return}if(r==="moveShape"){ot([a.dx,a.dy],a);return}if(r==="moveWhole"){var G,X;w.current=w.current.translate(i,l),g.sPX().transform(b.current,w.current),b.current.selectAll("g.layer").attr("transform",w.current),b.current.selectAll("g#shape-related-group").attr("transform","translate(".concat((G=w.current)===null||G===void 0?void 0:G.x,",").concat((X=w.current)===null||X===void 0?void 0:X.y,")")),Mr()}if(r==="movePoint"){var Q,ur,tr="",hr=(Q=o.current)===null||Q===void 0||(ur=Q.attr("id"))===null||ur===void 0?void 0:ur.substring(6),nr=m.current[hr],lr=nr.attrs.points,fr=nr.shape_type,vr=fr==="polygon";O.current?tr=O.current:tr=u.attr("id").substring(11),lr[tr-1]=c,m.current[hr].attrs={points:lr};var Cr=j.current(lr);o.current.attr("d",Cr+(vr?"Z":"")),Er(a),Lr(hr,d.current.showLabel)}},Qt=function(r){var t=(r==null?void 0:r.target)||(r==null?void 0:r.srcElement),e=g.Ys(t).attr("id"),n=U.current||[],a=n.length;if(g.td_("#path-point-group circle").attr("r",k.point.r),r.type==="touchstart"||r.type==="mouseenter"){if(H.current&&(e!=="path-point-1"||a<3))return;g.Ys("#".concat(e)).attr("r",6),g.Ys(t).style("cursor","pointer")}else g.Ys(t).style("cursor",null)},Qr=function(r,t){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=g.Ys("#path-point-group"),a=n.selectAll("circle"),u=a.size(),c=k.point;if(!u||u<=t){var i=n.append("circle").attr("id",r).call(xr("point",Sr));return i.on("touchstart touchend mouseenter mouseleave",Qt),Object.keys(c).forEach(function(l){i.attr(l,c[l])}),i.attr("display",e?"inline":"none"),i}return g.Ys("#"+r).attr("display",e?"inline":"none")},Vt=function(r){var t,e=ir(r),n=E.current.substring(6),a=(t=m.current)===null||t===void 0?void 0:t[n],u=a.attrs.points,c=a.shape_type,i=u.length,l=-1,s=1/0,f={};f[n]=JSON.parse(JSON.stringify(m.current[n])),sr("edit",o.current,f);for(var h=0;h<i;h++){var v=(h+1)%i,p=u[h],S=u[v],C=Mt(e,p,S);C<s&&(l=v,s=C)}u.splice(l,0,e);var L=j.current(u);c==="polygon"&&(L+="Z"),o.current.attr("d",L);var A="path-point-".concat(i+1);Qr(A,i),Er(r)},st=function(r){var t,e;(t=g.Ys("#path-stretch-line"))===null||t===void 0||t.attr("display","none");var n=o.current.attr("d");r&&o.current.attr("d",n+"Z");var a=(e=o.current.attr("id"))===null||e===void 0?void 0:e.substring("6"),u=d.current,c=u.curLabel,i=u.colorBindLabel;i&&c&&!P.current[c]&&(P.current[c]=k.shapeCommon.stroke,d.current.changeBindColor(P.current)),c=c||a,m.current[a]={shape_type:r?"polygon":"line",label:c,attrs:{points:U.current}},U.current=null,B.current="shape-".concat(a),E.current=B.current,g.Ys("#"+E.current).attr("fill",Tr(o.current.attr("stroke"))),d.current.changeSize(cr()),d.current.changeSelect(dr()),Ir(a,c,!0),b.current.select("#path-add-point").attr("display","inline"),it(a),sr("add",o.current),d.current.endDraw({id:a,label:c})},qt=function(r,t,e,n){var a,u=(r==null?void 0:r.sourceEvent)||r,c=U.current||[],i=c==null?void 0:c.length;if(u.button===2){if(!i)return;i<2?kr():st();return}if(e==="point"&&n.attr("id")==="path-point-1"&&i>=3){st(!0);return}var l=g.Ys("#path-point-group"),s=l.selectAll("circle"),f=s.size(),h=ir(r),v=K()(h,2),p=v[0],S=v[1],C=k.line;if(i){U.current.push([p,S]);var X=j.current(U.current);o.current.attr("d",X)}else{var L;H.current=!0,V(),(L=g.Ys("#path-stretch-line"))===null||L===void 0||L.attr("display","inline"),Nr();var A=Object.assign({},k.shapeCommon,k[t]);o.current=D.current.select("#shape").append(t).call(xr("shape",Sr));var G=mr();o.current.attr("id","shape-".concat(G)),Object.keys(A).forEach(function(nr){o.current.attr(nr,A[nr])}),U.current=[[p,S]]}f||(l.append("path").attr("id","path-stretch-line").style("pointer-events","none"),Object.keys(C).forEach(function(nr){g.Ys("#path-stretch-line").attr(nr,C[nr])}));var Q="path-point-".concat(i+1);Qr(Q,i);var ur=(w==null||(a=w.current)===null||a===void 0?void 0:a.k)||1,tr=p*ur,hr=S*ur;g.Ys("#"+Q).attr("cx",tr).attr("cy",hr),Kr(r)},dt=function(r){Zt(r),Gt(r),Kr(r)},$t=function(r,t,e){var n=d.current.drawTool;if(!(!n||t.defaultPrevented)){if(r==="grip"){var a=e.attr("id");Y.current&&g.Ys("#"+Y.current).attr("fill",k.grip.fill),Y.current===a?Y.current=null:(Y.current=a,e.attr("fill","#ff0"),Gr(t));return}if(Y.current){var u=Wr();sr.apply(void 0,["edit"].concat(er()(u))),u=null,Sr("moveGrip",t,e),d.current.changeSize(cr());return}if(r==="point"){var c=e.attr("id").substring(11);O.current&&g.Ys("#path-point-"+O.current).attr("fill",k.point.fill),O.current===c?O.current=null:(O.current=c,e.attr("fill","#ff0"),Gr(t));return}if(O.current){var i=Wr();sr.apply(void 0,["edit"].concat(er()(i))),i=null,Sr("movePoint",t,e),d.current.changeSize(cr());return}if(r==="insertPoint"){Vt(t);return}if(r==="shape"){var l;Ur(e,N.current||(t==null||(l=t.sourceEvent)===null||l===void 0?void 0:l.shiftKey));return}if(r==="whole"){V(),o.current=null,x.current=null,d.current.changeSelect([]);return}}},ft=function(){if(!o.current||!W.current)return!1;W.current=!1,V();var r=It();if(r)return!1;var t=d.current,e=t.drawTool,n=t.curLabel,a=t.colorBindLabel,u=mr();a&&n&&!P.current[n]&&(P.current[n]=k.shapeCommon.stroke,d.current.changeBindColor(P.current)),n=n||u,o.current.attr("id","shape-".concat(u)),m.current[u]={shape_type:e,label:n,attrs:U.current},U.current=null,Yr(),d.current.changeSize(cr()),Ir(u,n,e==="ellipse"),sr("add",o.current),d.current.endDraw({id:u,label:n})},_t=function(r){var t=ir(r);W.current=!0,o.current=null,V();var e=K()(t,2);return R.current.x=e[0],R.current.y=e[1],g.Ys("#shape-selector").attr("display","inline").attr("x",t[0]).attr("y",t[1]).attr("width",0).attr("height",0),!1},re=function(){var r,t=g.Ys("#shape-selector").node().getBoundingClientRect(),e=Object.keys(m.current),n=[],a=(w==null||(r=w.current)===null||r===void 0?void 0:r.k)||1;e==null||e.forEach(function(u){var c=g.Ys("#shape-".concat(u)),i=n.length,l=g.Ys("#shape-path-group #shape-path-".concat(i)),s=c.node().getBoundingClientRect(),f=s.bottom>t.top&&s.top<t.bottom&&s.left<t.right&&s.right>t.left;if(f){n.push(u);var h=c.node().getBBox(),v=h.x,p=h.y,S=h.width,C=h.height;l.node()?l.attr("display","inline"):l=Hr(i),v=v*a||0,p=p*a||0,S=S*a||0,C=C*a||0;var L=[[v-2,p-2],[v+S+2,p-2],[v+S+2,p+C+2],[v-2,p+C+2]],A=j.current(L);l.attr("d",A+"Z")}else l.node()&&l.attr("display","none")}),x.current=(n==null?void 0:n.length)&&n},te=function(r){var t;if(!W.current)return!1;var e=ir(r),n=R.current,a=n.x,u=n.y,c=e[0]-a,i=e[1]-u,l=(w==null||(t=w.current)===null||t===void 0?void 0:t.k)||1,s=Math.abs(c),f=Math.abs(i);return c<0&&(a=e[0]),i<0&&(u=e[1]),a=a*l||0,u=u*l||0,s=s*l||0,f=f*l||0,g.Ys("#shape-related-group #shape-selector").attr("x",a).attr("y",u).attr("width",s).attr("height",f),re(),!1},ee=function(){if(!W.current)return!1;W.current=!1,g.td_("#shape-related-group #shape-selector").attr("display","none")},ne=function(r,t,e){var n;return r==="grip"?"moveGrip":r==="point"&&!H.current?"movePoint":r==="insertPoint"?r:t==="drag"||ar.current&&!N.current&&!z.current?"moveWhole":r==="shape"&&!ar.current&&(t==="move"||E.current===e.attr("id")||x.current&&x.current.includes((n=e.attr("id"))===null||n===void 0?void 0:n.substring(6)))?"moveShape":r==="whole"&&t==="move"&&!ar.current&&!z.current?"selectShape":t==="rect"||t==="ellipse"?"shape":t},xr=function(r,t){var e="",n="",a=null,u=!1,c=null;return g.ohM().filter(function(i){return Pr(),e=d.current.drawTool,a=g.Ys(this),n=ne(r,e,a),e?!i.button||i.button===2&&H.current&&n==="path":!1}).on("start",function(i){var l,s;if(i==null||(l=i.sourceEvent)===null||l===void 0||l.stopPropagation(),i==null||(s=i.sourceEvent)===null||s===void 0||s.preventDefault(),Z.current=!1,u=!1,!(Y.current||O.current)){if(n==="path"){x.current=null,qt(i,e,r,a);return}if(n==="moveShape"){var f,h,v=(f=a.attr("id"))===null||f===void 0?void 0:f.substring(6);if(!x.current&&E.current!==a.attr("id")||x.current&&!x.current.includes(v)){var p;u=!0,Ur(a,N.current||(i==null||(p=i.sourceEvent)===null||p===void 0?void 0:p.shiftKey))}(z.current||i!=null&&(h=i.sourceEvent)!==null&&h!==void 0&&h.altKey)&&pt()}else if(n.indexOf("move")>=0&&n.length>4){n==="moveWhole"?w.current=w.current||g.CRH:n==="moveGrip"&&Gr(i);var S=ir(i),C=K()(S,2);R.current.mx=C[0],R.current.my=C[1]}n.indexOf("move")>=0&&n.length>4&&n!=="moveWhole"&&(c=Wr())}}).on("drag",function(i){var l,s;if(i==null||(l=i.sourceEvent)===null||l===void 0||l.stopPropagation(),i==null||(s=i.sourceEvent)===null||s===void 0||s.preventDefault(),i!=null&&i.sourceEvent&&dt(i.sourceEvent),!(Y.current||O.current||n==="path"||n==="insertPoint")&&!(i.dx===0&&i.dy===0)){if(Z.current=!0,n.indexOf("move")>=0){t(n,i,a);return}if(n==="shape"){W.current?ie(i,e):(x.current=null,ae(i,e));return}n==="selectShape"&&(W.current?te(i):_t(i))}}).on("end",function(i){var l,s;if(i==null||(l=i.sourceEvent)===null||l===void 0||l.stopPropagation(),i==null||(s=i.sourceEvent)===null||s===void 0||s.preventDefault(),Z.current)if(n==="shape"){ft(),d.current.changeSelect(dr());return}else if(n==="selectShape"){ee(),d.current.changeSelect(dr());return}else n!=="moveWhole"&&n.indexOf("move")>=0&&n.length>4&&(d.current.changeSize(cr()),c&&sr.apply(void 0,["edit"].concat(er()(c))),c=null);else if(H.current&&n==="path")U.current||(H.current=!1);else if(!u){$t(r,i,a);return}})},Vr=function(r){var t,e="",n=e.drawTool;return g.sPX().scaleExtent((t=d.current)===null||t===void 0?void 0:t.scaleExtent).filter(function(a){return(!a.ctrlKey||a.type==="wheel")&&!a.button}).on("start",function(a){var u,c;n=d.current.drawTool,Pr(),a==null||(u=a.sourceEvent)===null||u===void 0||u.stopPropagation(),a==null||(c=a.sourceEvent)===null||c===void 0||c.preventDefault()}).on("zoom",function(a){var u,c;a==null||(u=a.sourceEvent)===null||u===void 0||u.stopPropagation(),a==null||(c=a.sourceEvent)===null||c===void 0||c.preventDefault(),n&&r&&r(a)}).on("end",function(a){var u,c;a==null||(u=a.sourceEvent)===null||u===void 0||u.stopPropagation(),a==null||(c=a.sourceEvent)===null||c===void 0||c.preventDefault()})},vt=function(r){var t,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;e&&(w.current=r.transform),b.current.selectAll("g.layer").attr("transform",w.current),b.current.selectAll("g#shape-related-group").attr("transform","translate(".concat(w.current.x,", ").concat(w.current.y,")")),(t=x.current)!==null&&t!==void 0&&t.length?jr():(Yr(),e?Er(r):Er()),Zr(),Mr(),$.current=w.current.k,d.current.changeScale($.current)},ht=function(r){var t,e,n=!0,a=r;if(!a){var u;a=o.current,a.attr("fill",k.shapeCommon.fill),n=!1,(u=b.current.select("#path-add-point"))===null||u===void 0||u.attr("display","inline")}var c=(t=a.attr("id"))===null||t===void 0?void 0:t.substring(6),i=m.current[c],l=i.label,s=i.shape_type,f=a.clone(),h=mr();return f=D.current.select("#shape").append(function(){return f.node()}).attr("id","shape-".concat(h)).call(xr("shape",Sr)),m.current[h]=JSON.parse(JSON.stringify((e=m.current)===null||e===void 0?void 0:e[c])),Ir(h,l,s!=="rect"),n?""+h:(f.attr("fill",Tr(f.attr("stroke"))),E.current="shape-".concat(h),f)},pt=function(){if(x.current){var r,t=[];(r=x.current)===null||r===void 0||r.forEach(function(e){var n=g.Ys("#shape-".concat(e));t.push(ht(n))}),x.current=t,d.current.changeSelect(dr()),sr("add",x.current);return}o.current&&(o.current=ht(),d.current.changeSelect(dr()),sr("add",o.current))},ae=function(r,t){var e=ir(r);W.current=!0,o.current=D.current.select("#shape").append(t).call(xr("shape",Sr)),Nr();var n=Object.assign({},k.shapeCommon,k[t]),a="x",u="y";t==="ellipse"&&(a="cx",u="cy");var c=K()(e,2);R.current.x=c[0],R.current.y=c[1];var i=K()(e,2);return n[a]=i[0],n[u]=i[1],Object.keys(n).forEach(function(l){o.current.attr(l,n[l])}),!1},ie=function(r,t){if(!o.current||!W.current)return!1;var e=ir(r),n=R.current,a=n.x,u=n.y,c=e[0]-a,i=e[1]-u;if(t==="rect"){var l=Math.abs(c),s=Math.abs(i);return c<0&&(N.current&&l<s?a=a-s:a=e[0]),i<0&&(N.current&&l>s?u=u-l:u=e[1]),N.current&&(l>s?s=l:l=s),U.current={x:a,y:u,width:l,height:s},o.current.attr("x",a).attr("y",u).attr("width",l).attr("height",s),!1}if(t==="ellipse"){var f=c/2||0,h=i/2||0,v=Math.abs(f),p=Math.abs(h);N.current&&(v>p?(h=h>0?v:-v,p=v):(f=f>0?p:-p,v=p)),a=a+f,u=u+h,U.current={cx:a,cy:u,rx:v,ry:p},o.current.attr("cx",a).attr("cy",u).attr("rx",v).attr("ry",p)}return!1},ce=function(r){if(r!=="path"&&H.current){kr(),H.current=!1;return}},ue=function(){if(W.current){ft();return}},le=function(r){ar.current=r.ctrlKey,z.current=r.altKey,N.current=r.shiftKey;var t=r.keyCode||r.which||r.charCode;if(H.current){t===27&&kr();return}if(t===8||t===46){O.current?(Ht(),d.current.changeSize(cr())):Xr();return}if(ar.current&&t===67){var e;yr.current=x.current&&er()(x.current)||((e=o.current)===null||e===void 0?void 0:e.attr("id"))||null}if(ar.current&&t===86){if(!yr.current)return;V();var n=Yt()(yr.current)==="object";n?x.current=er()(yr.current):o.current=g.Ys("#".concat(yr.current)),pt(),n?jr():["rect","ellipse"].includes(m.current[yr.current.substring(6)].shape_type)?Yr():Er(),d.current.changeSize(cr())}if([37,38,39,40].includes(t)){var a=0,u=0;t===37?a=-1:t===38?u=-1:t===39?a=1:t===40&&(u=1);var c=Wr();sr.apply(void 0,["edit"].concat(er()(c))),c=null,ot([a,u],r)}},oe=function(r){ar.current=r.ctrlKey,z.current=r.altKey,N.current=r.shiftKey},gt=function(r){r?g.Ys("body").on("keyup",oe):(g.Ys("body").on("keyup",null),ar.current=!1,z.current=!1,N.current=!1,ue())},se=function(){var r;(r=g.Ys(T.current).select("div>svg"))===null||r===void 0||r.remove(),b.current=g.Ys(T.current).selectChild("div").append("svg").attr("id","svgroot");var t=b.current.append("defs"),e=t.append("pattern").attr("id","gridPattern").attr("patternUnits","userSpaceOnUse").attr("x",0).attr("y",0).attr("width","10").attr("height","10"),n=e.append("rect");n.attr("fill","none").attr("stroke","#787878").attr("stroke-width","0.5").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%"),D.current=b.current.append("svg").attr("id","svgcont"),D.current.append("g").attr("class","layer").attr("id","img").style("pointer-events","none"),D.current.append("g").attr("class","layer").attr("id","shape");var a=b.current.append("g").attr("id","shape-related-group"),u=a.append("rect").attr("id","shape-selector").attr("display","none").style("pointer-events","none"),c=Object.assign({},k.rect,k.selectBox);Object.keys(c).forEach(function(S){u.attr(S,c[S])});var i=a.append("path").attr("id","path-add-point").attr("display","none"),l=k.pathAddPoint;Object.keys(l).forEach(function(S){i.attr(S,l[S])}),a.append("g").attr("class","grip-layer").attr("id","shape-grip-group").attr("display","none"),g.Ys("#shape-grip-group").append("path").attr("id","resize-path").style("pointer-events","none");var s=k.line;Object.keys(s).forEach(function(S){g.Ys("#resize-path").attr(S,s[S])});for(var f=0;f<8;f++)g.Ys("#shape-grip-group").append("rect").attr("id","resize-grip-"+et[f]).style("cursor",et[f]+"-resize");var h=k.grip;if(Object.keys(h).forEach(function(S){g.td_("#shape-grip-group rect").attr(S,h[S])}),console.log(99,d.current.rotateEnable),d.current.rotateEnable){g.Ys("#shape-grip-group").append("line").attr("id","rotate-line").style("pointer-events","none"),Object.keys(s).forEach(function(S){g.Ys("#rotate-line").attr(S,s[S])}),g.Ys("#shape-grip-group").append("circle").attr("id","rotate-circle").style("cursor","url(/imgs/rotate.png) 12 12, auto");var v=k.rotateCircle;Object.keys(v).forEach(function(S){g.Ys("#rotate-circle").attr(S,v[S])})}a.append("g").attr("class","point_layer").attr("id","path-point-group"),a.append("g").attr("class","path_layer").attr("id","shape-path-group").style("pointer-events","none"),a.append("g").attr("class","label_layer").attr("id","shape-label-group").attr("display","none").style("pointer-events","none"),a.append("rect").attr("id","grid").attr("display","none").style("pointer-events","none").attr("x",0).attr("y",0).attr("width","0").attr("height","0").attr("fill","url(#gridPattern)").attr("stroke","none");var p=b.current.append("g").attr("class","crosshair_layer").style("pointer-events","none").attr("display","none");p.append("rect").attr("id","crosshair-v-line").attr("width",.5).attr("height","100%"),p.append("rect").attr("id","crosshair-h-line").attr("width","100%").attr("height",.5),p.selectAll("rect").attr("x",0).attr("y",0).attr("fill","#00f").attr("stroke","none")},Br=function(){var r=T.current.getBoundingClientRect(),t=r.right-r.left||k.svg.width,e=r.bottom-r.top||k.svg.height,n=[t,e];k.svg.width=n[0],k.svg.height=n[1],g.Ys("#svgcanvas").style("width",t+"px").style("height",e+"px"),g.td_("#svgroot,#svgcont").attr("width",t).attr("height",e)},de=function(){b.current.on("mousemove touchmove",dt).call(xr("whole",Sr)).call(Vr(function(r){vt(r)})).on("dblclick.zoom",null),g.td_("#shape-grip-group rect").call(xr("grip",Sr)),b.current.select("#path-add-point").call(xr("insertPoint",Sr))},fe=function(){j.current=g.jvg(),se(),Br(),de(),qr(d.current.showCrosshair)},yt=function(){b.current.selectAll("g.layer,g#shape-related-group").attr("transform",null),w.current=null,b.current.call(Vr().transform,g.CRH),d.current.changeScale("1")},St=function(){var r,t,e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;_.current=[],rr.current=[],V(),o.current&&(o.current=null),x.current&&(x.current=null),m.current={},e&&d.current.changeSize(cr()),I.current=[],d.current.changeSelect([]),(r=b.current.selectAll("#shape *"))===null||r===void 0||r.remove(),(t=b.current.selectAll("#shape-label-group *"))===null||t===void 0||t.attr("display","none")},ve=function(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;(r=D.current.select("g#img").select("image"))===null||r===void 0||r.remove(),St(t),yt()},he=function(r){var t,e,n=m.current[r].hide,a=(t=o.current)===null||t===void 0||(e=t.attr("id"))===null||e===void 0?void 0:e.substring(6);if(n=!n,m.current[r].hide=n,b.current.selectAll("g#shape #shape-".concat(r,",#shape-label-").concat(r)).attr("display",n?"none":"inline"),x.current&&x.current.includes(r)){var u,c=x.current.indexOf(r);if(x.current.splice(c,1),!((u=x.current)!==null&&u!==void 0&&u.length))x.current=null,g.td_("#shape-path-group *").attr("display","none"),d.current.changeSelect([]);else{var i;(i=g.Ys("#shape-path-".concat(x.current.length)))===null||i===void 0||i.attr("display","none"),jr(),d.current.changeSelect(dr())}}else a&&a===r&&(V(),o.current=null,d.current.changeSelect([]));d.current.changeSize(cr())},bt=function(r){return r?(Br(),new Promise(function(t){var e=new Image;e.onload=function(n){var a,u,c=n.target.width,i=n.target.height,l=c,s=i,f=0,h=0,v=1,p=k.svg,S=p.width,C=p.height,L=S/C,A=c/i;L>A?(s=C,l=s*A,v=i/s):(l=S,s=l/A,v=c/l),f=(S-l)/2,h=(C-s)/2,or.current={x:f,y:h,scale:v,w:l,h:s},(a=D.current.select("g#img").select("image"))===null||a===void 0||a.remove(),(u=D.current.select("g#img").append("image").attr("width",l).attr("height",s).attr("x",f).attr("y",h).attr("xlink:href",r).attr("draggable","false"))===null||u===void 0||u.style("filter",wr.current),Mr(),d.current.imgLoaded({width:c,height:i}),t(!0)},e.onerror=function(){d.current.imgLoaded(!1),t(!1)},e.src=r})):!1},pe=function(r){if(r){var t=Object.keys(m.current);t==null||t.forEach(function(e){var n=b.current.select("#shape-".concat(e));b.current.select("#shape-label-".concat(e)).attr("fill",n.attr("stroke"))})}},ge=function(r){b.current.select("#grid").attr("display",r&&(!w.current||w.current.k>=1)?"inline":"none"),Mr(!0)},qr=function(r){b.current.select(".crosshair_layer").attr("display",r&&M.drawTool!=="move"&&M.drawTool!=="drag"?"inline":"none")},ye=function(r){var t;wr.current=r,(t=D.current.select("#img image"))===null||t===void 0||t.style("filter",r)},Se=function(r){b.current.select("#shape-label-group").attr("display",r?"inline":"none"),Zr(!0),pe(r)},be=function(r,t){if(m.current[r]){m.current[r].label=t,b.current.select("#shape-label-".concat(r)).text(t),d.current.changeSize(cr());var e=d.current,n=e.colorBindLabel,a=e.curLabel;if(n){var u="",c=P.current[t];a?u=P.current[t]||tt(P.current):u=k.shapeCommon.stroke,Fr(r,u),c||(P.current[t]=u,d.current.changeBindColor(P.current))}}},me=function(r){var t=+$.current,e=0,n=d.current.scaleExtent;isNaN(r)?r==="enlarge"?(e=(n[1]-t)/20,e=e>.1?e:.2,t=t+e):r==="narrow"&&(e=(t-n[0])/5,t=t-e):t=+r,t=t<n[0]?n[0]:t,t=t>n[1]?n[1]:t,Vr().scaleTo(b.current,t),w.current=g.P2S(b.current.node()),vt(w.current,!1)},we=function(r){if(!r||!(r!=null&&r.length))return[];var t=[];try{t=r.map(function(e){var n;if(!(e!=null&&e.attrs))return e;var a=e.attrs,u=e.shape_type,c=rt()(e,Nt);if(u.indexOf("rect")>=0){var i=a,l=i.x,s=i.y,f=i.width,h=i.height;return a=[[l,s],[l+f,s+h]],gr()({points:a,shape_type:"rectangle"},c)}else if(u==="ellipse"){var v=a,p=v.cx,S=v.cy,C=v.rx,L=v.ry;return C===L?(a=[[p,S],[p,S+L]],gr()({points:a,shape_type:"circle"},c)):(a=[[p,S],[p,S+L],[p+C,S]],gr()({points:a,shape_type:"ellipse"},c))}return gr()({points:(n=a)===null||n===void 0?void 0:n.points,shape_type:u},c)})}catch(e){console.error(e.toString())}return t},xe=function(r){if(!r||!(r!=null&&r.length))return[];var t=[];try{t=r.map(function(e,n){var a;if(e=gr()(gr()({},e),{},{id:"".concat(n+1)}),(a=e)!==null&&a!==void 0&&a.attrs)return e;var u=e,c=u.points,i=u.shape_type,l=rt()(u,Tt);if(i.indexOf("rect")>=0){var s=c,f=K()(s,2),h=K()(f[0],2),v=h[0],p=h[1],S=K()(f[1],2),C=S[0],L=S[1],A=Math.abs(C-v),G=Math.abs(L-p),X=v,Q=p;return X>C&&(X=C),Q>L&&(Q=L),c={x:X,y:Q,width:A,height:G},gr()({attrs:c,shape_type:"rect"},l)}else if(i==="circle"){var ur=c,tr=K()(ur,2),hr=K()(tr[0],2),nr=hr[0],lr=hr[1],fr=K()(tr[1],2),vr=fr[0],Cr=fr[1],pr=Math.sqrt(Math.pow(vr-nr,2)+Math.pow(Cr-lr,2));return c={cx:nr,cy:lr,rx:pr,ry:pr},gr()({attrs:c,shape_type:"ellipse"},l)}else if(i==="ellipse"){var Rr=c,zr=K()(Rr,3),Ar=K()(zr[0],2),Or=Ar[0],mt=Ar[1],Le=K()(zr[1],2),Re=Le[1],ke=K()(zr[2],1),De=ke[0],je=Re-mt,Be=De-Or;return c={cx:Or,cy:mt,rx:Be,ry:je},gr()({attrs:c,shape_type:"ellipse"},l)}else if(i==="polygon")return gr()({attrs:{points:c},shape_type:i},l);return gr()({attrs:{points:c},shape_type:"line"},l)})}catch(e){console.error(e.toString())}return t},Ce=function(r,t,e,n,a){I.current.push(r),m.current[r]={label:e,shape_type:t,hide:n,attrs:a},e&&Ir(r,e,t!=="rect"),b.current.selectAll("g#shape #shape-".concat(r,",#shape-label-").concat(r)).attr("display",n?"none":"inline")},Ee=function(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!(!r||!(r!=null&&r.length)))try{var e=or.current,n=e.x,a=e.y,u=e.scale,c=D.current.select("#shape");r.forEach(function(i){var l=i.attrs,s=i.id,f=i.hide,h=i.label,v=i.shape_type,p=null,S=null;if(v==="rect"||v==="ellipse"){var C,L=Dr(v),A=l[L.x],G=l[L.y],X=l[L.w],Q=l[L.h];if(!+X||!+Q)return;s||(s=mr()),p=c.append(v).attr("id","shape-".concat(s)).call(xr("shape",Sr)),Nr(h);var ur=Object.assign({},k.shapeCommon,k[v]);Object.keys(ur).forEach(function(Or){p.attr(Or,ur[Or])}),A=+A/u+n,G=+G/u+a,X=X/u,Q=Q/u,p.attr(L.x,A).attr(L.y,G).attr(L.w,X).attr(L.h,Q),S=(C={},Jr()(C,L.x,A),Jr()(C,L.y,G),Jr()(C,L.w,X),Jr()(C,L.h,Q),C)}else{s||(s=mr()),Nr(h);var tr=l.points,hr=tr.length,nr=c.append("path").attr("id","shape-".concat(s)).call(xr("shape",Sr)),lr=Object.assign({},k.shapeCommon,k.path),fr=[];Object.keys(lr).forEach(function(Or){nr.attr(Or,lr[Or])});for(var vr=0;vr<hr;vr++){var Cr=K()(tr[vr],2),pr=Cr[0],Rr=Cr[1];pr=+pr/u+n,Rr=+Rr/u+a,fr[vr]=[pr,Rr];var zr="path-point-".concat(vr+1);Qr(zr,vr,!1)}var Ar=j.current(fr);v==="polygon"&&(Ar+="Z"),nr.attr("d",Ar),S={points:fr}}i.id=s,Ce(s,v,h,f,S)}),d.current.changeBindColor(P.current),t&&d.current.changeSize(r)}catch(i){console.error(i.toString())}},Oe=function(){return _.current.length>0},Pe=function(){return rr.current.length>0},Ye=function(r){r&&!T.current&&(T.current=r)};return(0,J.useEffect)(function(){return T.current&&(fe(),window.addEventListener("resize",Br)),function(){g.Ys("body").on("keyup",null),window.removeEventListener("resize",Br)}},[]),(0,J.useEffect)(function(){M.src!==d.current.src&&bt(M.src),M.drawTool!==d.current.drawTool&&(ce(M.drawTool),qr(M.showCrosshair)),M.showLabel!==d.current.showLabel&&Se(M.showLabel),M.showGrid!==d.current.showGrid&&ge(M.showGrid),M.showCrosshair!==d.current.showCrosshair&&qr(M.showCrosshair),d.current=M},[M]),(0,J.useImperativeHandle)(F,function(){return{reload:ve,zoomReload:yt,loadImg:bt,clearShape:St,toggleShape:he,getMarkData:cr,selectShape:Ur,delSelectShape:Xr,getSelectIds:dr,editLabel:be,adjustImg:ye,undoSvg:Ut,canUndo:Oe,redoSvg:Xt,canRedo:Pe,changeScale:me,changeColor:Kt,drawShapeFromSize:Ee,setCanvasSize:Br,convertToPoints:we,convertToAttrs:xe}}),(0,br.jsxs)("div",{ref:Ye,className:"w-draw-container ".concat(d.current.className||""),onKeyDown:le,children:[(0,br.jsx)("div",{id:"svgcanvas",className:"w-svg-box",tabIndex:-1,onFocus:function(){return gt(!0)},onBlur:function(){return gt(!1)}}),M==null?void 0:M.children]})});nt.defaultProps={src:"",curLabel:"",showLabel:!1,showGrid:!1,showCrosshair:!1,minSize:[4,4],drawTool:"",scaleExtent:[.02,30],colorBindLabel:!0,rotateEnable:!0,changeSize:function(){},changeBindColor:function(){},changeSelect:function(){},changeScale:function(){},imgLoaded:function(){},endDraw:function(){}};var Ft=nt,at=function(F){var d=F.shapeList,T=F.selectShapeIds,b=F.delFunc,D=F.selectFunc,o=F.leftRender,E=F.rightRender,B=F.topRender,Y=F.title,O=F.className,j=(0,J.useRef)(null),w=(0,J.useState)([]),R=K()(w,2),W=R[0],H=R[1],Z=(0,J.useRef)(-1),I=(0,J.useRef)(-1);(0,J.useEffect)(function(){H(T)},[T]);var $=function(){I.current=-1,Z.current=-1;var z=d.length,m=T==null?void 0:T.length;if(!(!z||!m)){var U=er()(T);U.sort(function(rr,V){return rr-V});for(var P=0;P<z;P++){var _=d[P].id;_===U[0]&&(Z.current=P),_===U[m-1]&&(I.current=P)}}},or=function(z){z?(j.current.classList.add("box-active"),$()):j.current.classList.remove("box-active")},x=function(z){D&&(z.length===1?D(z[0]):D(z))},yr=function(z){var m=z.keyCode||z.which||z.charCode;if(m===8||m===46){z==null||z.stopPropagation(),b&&b();return}if(z.ctrlKey&&m===65){z==null||z.stopPropagation();var U=d==null?void 0:d.map(function(V){return V==null?void 0:V.id});H(er()(U)),x(U),I.current=d.length-1,Z.current=0;return}var P=-1,_=d.length-1;if(m===38&&(Z.current>0||W.length>1)?(P=Z.current-1,P=P<0?0:P):m===40&&(I.current<_||W.length>1)&&(P=I.current+1,P=P>_?_:P),P!==-1){var rr;z==null||z.stopPropagation(),W=[(rr=d[P])===null||rr===void 0?void 0:rr.id],H(W),x(W),I.current=P,Z.current=P}},wr=function(z,m,U){U.stopPropagation();var P=er()(W),_=P.indexOf(z);if(U.shiftKey){m<=Z.current?Z.current=m:I.current=m,Z.current=Z.current<0?0:Z.current,P=[];for(var rr=Z.current;rr<=I.current;rr++){var V;P.push((V=d[rr])===null||V===void 0?void 0:V.id)}}else if(U.ctrlKey)if(_>=0){if(P.length===1)Z.current=-1,I.current=-1;else if(m===Z.current)for(var Pr=Z.current+1;Pr<=I.current;Pr++){var ir;if(P.includes((ir=d[Pr])===null||ir===void 0?void 0:ir.id)){Z.current=Pr;break}}else if(m===I.current)for(var mr=I.current-1;mr>=Z.current;mr--){var Dr;if(P.includes((Dr=d[mr])===null||Dr===void 0?void 0:Dr.id)){I.current=mr;break}}P.splice(_,1)}else P.push(z),m<Z.current&&(Z.current=m),m>I.current&&(I.current=m);else P=[z],I.current=m,Z.current=m;H(P),x(P)},ar=function(){W.length&&(H([]),x([]),I.current=-1,Z.current=-1)};return(0,br.jsxs)("div",{className:"win-box ".concat(O),children:[(0,br.jsxs)("div",{className:"w-head",children:[Y||"\u56FE\u5F62\u5217\u8868",(0,br.jsx)("div",{className:"flex-center",children:B&&B()})]}),(0,br.jsx)("div",{className:"w-box w-box-overflow",ref:j,tabIndex:-1,onFocus:function(){return or(!0)},onBlur:function(){return or(!1)},onClick:ar,onKeyDown:yr,children:d&&d.map(function(N,z){var m=N==null?void 0:N.id;return(0,br.jsxs)("div",{className:"list-item ".concat(W.includes(m)?"on":""),onClick:function(P){return wr(m,z,P)},children:[o&&o(N,z),(0,br.jsx)("p",{className:"list-txt",title:N==null?void 0:N.label,children:N==null?void 0:N.label}),E&&E(N,z)]},z)})})]})};at.defaultProps={className:"",title:"",shapeList:[],selectShapeIds:[],leftRender:null,rightRender:null,topRender:null,delFunc:function(){},selectFunc:function(){}};var Wt=at}}]);
