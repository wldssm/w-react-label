"use strict";(self.webpackChunkw_react_label=self.webpackChunkw_react_label||[]).push([[970],{28970:function(Ae,$r,q){q.r($r),q.d($r,{WColorBlock:function(){return xt},WDraw:function(){return Ft},WShapeList:function(){return Wt}});var wt=q(5574),K=q.n(wt),J=q(67294),mr=q(85893),_r=function(F){var d=F.colorBlocks,T=(0,J.useState)(d[0]),y=K()(T,2),k=y[0],o=y[1];(0,J.useEffect)(function(){F.color&&o(F.color)},[]);var E=function(L,O){o(L),F.onChange&&F.onChange(L,O)};return(0,mr.jsx)("div",{className:"w-color-block-box",children:d.map(function(B,L){return(0,mr.jsx)("div",{onClick:function(j){return E(B,j)},className:"w-color-block ".concat(B===k?"on":""),style:{background:B}},L)})})};_r.defaultProps={color:"",colorBlocks:["#f00","#FFA500","#ff0","#0f0","#0ff","#00f","#800080","#fff"],onChange:function(){}};var xt=_r,Ct=q(9783),Jr=q.n(Ct),Et=q(97857),gr=q.n(Et),Ot=q(13769),rt=q.n(Ot),Pt=q(52677),Lt=q.n(Pt),Rt=q(19632),er=q.n(Rt),Yt=q(61227),kt=q.n(Yt),S=q(46886),D={color:["#CB3D45","#DA833C","#2378DE"],svg:{width:800,height:600},shapeCommon:{fill:"rgba(0, 0, 0, 0)",stroke:"#CB3D45","stroke-width":2,"vector-effect":"non-scaling-stroke"},rect:{x:0,y:0,width:0,height:0},selectBox:{"stroke-width":1,fill:"rgb(34 34 204 / 12%)",stroke:"rgb(34 34 204 / 45%)","vector-effect":"non-scaling-stroke"},ellipse:{cx:0,cy:0,rx:0,ry:0},path:{d:""},line:{d:"",fill:"none",stroke:"#00f","stroke-width":1},point:{cx:0,cy:0,r:4,fill:"rgba(0,0,255,.45)",stroke:"rgba(0, 0, 0, 0)","stroke-width":10},grip:{width:8,height:8,fill:"rgba(0,0,255,.45)",stroke:"rgba(0, 0, 0, 0)","stroke-width":10},font:{x:0,y:0,fill:"#CB3D45",stroke:"none","font-size":16,"text-anchor":"start","dominant-baseline":"text-after-edge"},pathAddPoint:{fill:"none",stroke:"rgba(0,0,0,0)","stroke-width":25}},Dt=["128, 0, 0","0, 128, 0","128, 128, 0","0, 0, 128","128, 0, 128","0, 128, 128","128, 128, 128","64, 0, 0","192, 0, 0","64, 128, 0","192, 128, 0","64, 0, 128","192, 0, 128","64, 128, 128","192, 128, 128","0, 64, 0","128, 64, 0","0, 192, 0","128, 192, 0","0, 64, 128","128, 64, 128","0, 192, 128","128, 192, 128","64, 64, 0","192, 64, 0","64, 192, 0","192, 192, 0","64, 64, 128","192, 64, 128","64, 192, 128","192, 192, 128","0, 0, 64","128, 0, 64","0, 128, 64","128, 128, 64","0, 0, 192","128, 0, 192","0, 128, 192","128, 128, 192","64, 0, 64","192, 0, 64","64, 128, 64","192, 128, 64","64, 0, 192","192, 0, 192","64, 128, 192","192, 128, 192","0, 64, 64","128, 64, 64","0, 192, 64","128, 192, 64","0, 64, 192","128, 64, 192","0, 192, 192","128, 192, 192","64, 64, 64","192, 64, 64","64, 192, 64","192, 192, 64","64, 64, 192","192, 64, 192","64, 192, 192","192, 192, 192","32, 0, 0","160, 0, 0","32, 128, 0","160, 128, 0","32, 0, 128","160, 0, 128","32, 128, 128","160, 128, 128","96, 0, 0","224, 0, 0","96, 128, 0","224, 128, 0","96, 0, 128","224, 0, 128","96, 128, 128","224, 128, 128","32, 64, 0","160, 64, 0","32, 192, 0","160, 192, 0","32, 64, 128","160, 64, 128","32, 192, 128","160, 192, 128","96, 64, 0","224, 64, 0","96, 192, 0","224, 192, 0","96, 64, 128","224, 64, 128","96, 192, 128","224, 192, 128","32, 0, 64","160, 0, 64","32, 128, 64","160, 128, 64","32, 0, 192","160, 0, 192","32, 128, 192","160, 128, 192","96, 0, 64","224, 0, 64","96, 128, 64","224, 128, 64","96, 0, 192","224, 0, 192","96, 128, 192","224, 128, 192","32, 64, 64","160, 64, 64","32, 192, 64","160, 192, 64","32, 64, 192","160, 64, 192","32, 192, 192","160, 192, 192","96, 64, 64","224, 64, 64","96, 192, 64","224, 192, 64","96, 64, 192","224, 64, 192","96, 192, 192","224, 192, 192","0, 32, 0","128, 32, 0","0, 160, 0","128, 160, 0","0, 32, 128","128, 32, 128","0, 160, 128","128, 160, 128","64, 32, 0","192, 32, 0","64, 160, 0","192, 160, 0","64, 32, 128","192, 32, 128","64, 160, 128","192, 160, 128","0, 96, 0","128, 96, 0","0, 224, 0","128, 224, 0","0, 96, 128","128, 96, 128","0, 224, 128","128, 224, 128","64, 96, 0","192, 96, 0","64, 224, 0","192, 224, 0","64, 96, 128","192, 96, 128","64, 224, 128","192, 224, 128","0, 32, 64","128, 32, 64","0, 160, 64","128, 160, 64","0, 32, 192","128, 32, 192","0, 160, 192","128, 160, 192","64, 32, 64","192, 32, 64","64, 160, 64","192, 160, 64","64, 32, 192","192, 32, 192","64, 160, 192","192, 160, 192","0, 96, 64","128, 96, 64","0, 224, 64","128, 224, 64","0, 96, 192","128, 96, 192","0, 224, 192","128, 224, 192","64, 96, 64","192, 96, 64","64, 224, 64","192, 224, 64","64, 96, 192","192, 96, 192","64, 224, 192","192, 224, 192","32, 32, 0","160, 32, 0","32, 160, 0","160, 160, 0","32, 32, 128","160, 32, 128","32, 160, 128","160, 160, 128","96, 32, 0","224, 32, 0","96, 160, 0","224, 160, 0","96, 32, 128","224, 32, 128","96, 160, 128","224, 160, 128","32, 96, 0","160, 96, 0","32, 224, 0","160, 224, 0","32, 96, 128","160, 96, 128","32, 224, 128","160, 224, 128","96, 96, 0","224, 96, 0","96, 224, 0","224, 224, 0","96, 96, 128","224, 96, 128","96, 224, 128","224, 224, 128","32, 32, 64","160, 32, 64","32, 160, 64","160, 160, 64","32, 32, 192","160, 32, 192","32, 160, 192","160, 160, 192","96, 32, 64","224, 32, 64","96, 160, 64","224, 160, 64","96, 32, 192","224, 32, 192","96, 160, 192","224, 160, 192","32, 96, 64","160, 96, 64","32, 224, 64","160, 224, 64","32, 96, 192","160, 96, 192","32, 224, 192","160, 224, 192","96, 96, 64","224, 96, 64","96, 224, 64","224, 224, 64","96, 96, 192","224, 96, 192","96, 224, 192","224, 224, 192","0,0,0"],tt=function(F){var d=Object.keys(F).length;return"rgb("+Dt[d]+")"},et=["n","ne","e","se","s","sw","w","nw"],jt=function(F){return!!(F.touches&&F.touches.length)},Bt=function(F,d){for(var T=arguments.length,y=new Array(T>2?T-2:0),k=2;k<T;k++)y[k-2]=arguments[k];var o={},E=y[0],B=y[1],L=y[2],O=y[3];if(F==="rect"){if(o=At.apply(void 0,y),d){var j=O.width,b=O.height,Y=o.width-o.height,W=E.indexOf("n")>=0&&L<=b||E.indexOf("s")>=0&&L<=-b,G=E.indexOf("e")>=0&&B<=-j||E.indexOf("w")>=0&&B<=j;Y>0?(W&&(o.y=o.y-Y),o.height=o.width):(G&&(o.x=o.x+Y),o.width=o.height)}}else if(F==="ellipse"){if(o=zt.apply(void 0,y),d){var Z=O.rx,I=O.ry,$=o.rx-o.ry,or=E.indexOf("n")>=0&&L<=I*2||E.indexOf("s")>=0&&L<=-I*2,w=E.indexOf("e")>=0&&B<=-Z*2||E.indexOf("w")>=0&&B<=Z*2;$>0?(or&&($=-$),o.ry=o.rx,o.cy=o.cy+$):(w&&($=-$),o.cx=o.cx-$,o.rx=o.ry)}}else o=Jt.apply(void 0,[d].concat(y));return o},At=function(){for(var F=arguments.length,d=new Array(F),T=0;T<F;T++)d[T]=arguments[T];var y=d[0],k=d[1],o=d[2],E=d[3],B=E.x,L=E.y,O=E.width,j=E.height,b=O,Y=j;return y.indexOf("n")>=0?(Y=j-o,Y>0?L=L+o:L=L+j,Y=Math.abs(Y)):y.indexOf("s")>=0&&(Y=j+o,Y<0&&(L=L+j+o),Y=Math.abs(Y)),y.indexOf("w")>=0?(b=O-k,b<0?B=B+O:B=B+k,b=Math.abs(b)):y.indexOf("e")>=0&&(b=O+k,b<0&&(B=B+O+k),b=Math.abs(b)),{x:B,y:L,width:b,height:Y}},zt=function(){for(var F=arguments.length,d=new Array(F),T=0;T<F;T++)d[T]=arguments[T];var y=d[0],k=d[1],o=d[2],E=d[3],B=E.cx,L=E.cy,O=E.rx,j=E.ry;return k=k/2,o=o/2,y.indexOf("n")>=0?(j=j-o,L=L+o,j=Math.abs(j)):y.indexOf("s")>=0&&(j=j+o,L=L+o,j=Math.abs(j)),y.indexOf("w")>=0?(O=O-k,B=B+k,O=Math.abs(O)):y.indexOf("e")>=0&&(O=O+k,B=B+k,O=Math.abs(O)),{cx:B,cy:L,rx:O,ry:j}},Jt=function(F){for(var d=arguments.length,T=new Array(d>1?d-1:0),y=1;y<d;y++)T[y-1]=arguments[y];var k=T[0],o=T[1],E=T[2],B=T[3],L=B.points,O=B.boundRect,j=(L==null?void 0:L.length)||0,b=[],Y=O.x,W=O.y,G=O.width,Z=O.height,I=G/Z,$=k.indexOf("n")>=0,or=k.indexOf("s")>=0,w=k.indexOf("w")>=0,yr=k.indexOf("e")>=0,wr="";F&&(k.length===1?($||or?(o=E*I,wr="v"):(E=o/I,wr="h"),$?o=-o:w&&(E=-E)):(E=o/I,(w&&or||yr&&$)&&(E=-E)));for(var ar=0;ar<j;ar++){var N=er()(L[ar]),A=Math.abs(N[0]-Y)/G,m=Math.abs(N[1]-W)/Z;$&&(N[1]+=E*(1-m)),(or||wr==="h")&&(N[1]+=E*m),w&&(N[0]+=o*(1-A)),(yr||wr==="v")&&(N[0]+=o*A),b.push(N)}return{points:b}},Mt=function(F,d,T){var y=K()(F,2),k=y[0],o=y[1],E=K()(d,2),B=E[0],L=E[1],O=K()(T,2),j=O[0],b=O[1],Y=j-B,W=b-L,G=((k-B)*Y+(o-L)*W)/(Y*Y+W*W);return G<0?(Y=k-B,W=o-L):G>1?(Y=k-j,W=o-b):(Y=k-(B+G*Y),W=o-(L+G*W)),Math.sqrt(Y*Y+W*W)},Nt=["attrs","shape_type"],Tt=["points","shape_type"],nt=(0,J.forwardRef)(function(M,F){var d=(0,J.useRef)(M),T=(0,J.useRef)(null),y=(0,J.useRef)(null),k=(0,J.useRef)(null),o=(0,J.useRef)(null),E=(0,J.useRef)(null),B=(0,J.useRef)(null),L=(0,J.useRef)(""),O=(0,J.useRef)(null),j=(0,J.useRef)(null),b=(0,J.useRef)(null),Y=(0,J.useRef)({x:0,y:0,w:0,h:0,mx:0,my:0}),W=(0,J.useRef)(!1),G=(0,J.useRef)(!1),Z=(0,J.useRef)(!1),I=(0,J.useRef)([]),$=(0,J.useRef)("1"),or=(0,J.useRef)({x:0,y:0,scale:1,w:0,h:0}),w=(0,J.useRef)(null),yr=(0,J.useRef)(null),wr=(0,J.useRef)(""),ar=(0,J.useRef)(!1),N=(0,J.useRef)(!1),A=(0,J.useRef)(!1),m=(0,J.useRef)({}),H=(0,J.useRef)(null),P=(0,J.useRef)({}),_=(0,J.useRef)([]),rr=(0,J.useRef)([]),V=function(){var r;(r=S.td_("#shape-grip-group,#path-point-group *,#shape-path-group *,#path-add-point"))===null||r===void 0||r.attr("display","none"),B.current="",E.current&&(S.Ys("#"+E.current).attr("fill",D.shapeCommon.fill),E.current=""),L.current&&(S.Ys("#"+L.current).attr("fill",D.grip.fill),L.current=""),O.current&&(S.Ys("#path-point-"+O.current).attr("fill",D.point.fill),O.current="")},Pr=function(){if(document.getElementById("svgcanvas")!==document.activeElement){var r;(r=document.getElementById("svgcanvas"))===null||r===void 0||r.focus()}},ir=function(r){var t=(r==null?void 0:r.sourceEvent)||r,e=[];if(jt(t)?e=S.cx$(t.touches[0]||t.changedTouches[0],y.current.node()):e=S.cx$(t,y.current.node()),b.current){var n=b.current,a=n.x,c=n.y,u=n.k;e[0]=(e[0]-a)/u,e[1]=(e[1]-c)/u}return e},br=function(){for(var r=I.current.length||0,t=0,e=0;e<r;e++)if(+I.current[e]!==e+1){t=e+1;break}return t===0&&(t=r+1),t=""+t,I.current.splice(t-1,0,t),t},Dr=function(r){return r==="ellipse"?{x:"cx",y:"cy",w:"rx",h:"ry"}:{x:"x",y:"y",w:"width",h:"height"}},It=function(){var r=d.current.drawTool,t=M.minSize,e=0,n=0;return r==="rect"?(e=o.current.attr("width"),n=o.current.attr("height")):r==="ellipse"&&(e=o.current.attr("rx")*2||0,n=o.current.attr("ry")*2||0),+e<=t[0]||+n<=t[1]?(o.current.remove(),o.current=null,S.Ys("#shape-grip-group").attr("display","none"),!0):!1},Lr=function(){var r,t,e,n,a;if(!o.current||G.current||B.current)return!1;var c=(r=o.current.attr("id"))===null||r===void 0?void 0:r.substring(6),u=((t=m.current)===null||t===void 0?void 0:t[c])||!1,i=u.hide;if(S.Ys("#shape-grip-group").attr("display",i?"none":"inline"),!i){var l=(b==null||(e=b.current)===null||e===void 0?void 0:e.k)||1,s=(n=o.current)===null||n===void 0||(a=n.node())===null||a===void 0?void 0:a.getBBox(),f=s.x,h=s.y,v=s.width,p=s.height,x=D.grip.width/2,C=D.grip.height/2;f=f*l||0,h=h*l||0,v=v*l||0,p=p*l||0;var R=[[f,h],[f+v,h],[f+v,h+p],[f,h+p]],z=j.current(R);S.Ys("#resize-path").attr("d",z+"Z"),S.Ys("#resize-grip-nw").attr("x",f-x).attr("y",h-C),S.Ys("#resize-grip-n").attr("x",f+v/2-x).attr("y",h-C),S.Ys("#resize-grip-ne").attr("x",f+v-x).attr("y",h-C),S.Ys("#resize-grip-w").attr("x",f-x).attr("y",h+p/2-C),S.Ys("#resize-grip-e").attr("x",f+v-x).attr("y",h+p/2-C),S.Ys("#resize-grip-sw").attr("x",f-x).attr("y",h+p-C),S.Ys("#resize-grip-s").attr("x",f+v/2-x).attr("y",h+p-C),S.Ys("#resize-grip-se").attr("x",f+v-x).attr("y",h+p-C)}},it=function(r){var t,e;if(!H.current){for(var n=(t=m.current)===null||t===void 0?void 0:t[r],a=n.attrs.points,c=n.shape_type,u=a.length,i=(b==null||(e=b.current)===null||e===void 0?void 0:e.k)||1,l=[],s=0;s<u;s++){var f=K()(a[s],2),h=f[0],v=f[1];h=h*i,v=v*i,l[s]=[h,v]}var p=j.current(l);c==="polygon"&&(p+="Z"),y.current.select("#path-add-point").attr("d",p)}},Kr=function(r){var t,e=H.current||[],n=e.length;if(!(!G.current||!n)){var a=(b==null||(t=b.current)===null||t===void 0?void 0:t.k)||1,c=K()(e[n-1],2),u=c[0],i=c[1],l=ir(r),s=K()(l,2),f=s[0],h=s[1];u=u*a,i=i*a,f=f*a,h=h*a;var v=[[u,i],[f,h]],p=j.current(v);S.Ys("#path-stretch-line").attr("d",p)}},Er=function(r){var t,e,n,a,c;if(!o.current||!o.current.attr("id"))return!1;var u=(t=o.current.attr("id"))===null||t===void 0?void 0:t.substring(6),i=((e=m.current)===null||e===void 0||(n=e[u])===null||n===void 0||(a=n.attrs)===null||a===void 0?void 0:a.points)||H.current||[],l=i.length,s=(b==null||(c=b.current)===null||c===void 0?void 0:c.k)||1;if(l){it(u);for(var f=0;f<l;f++){var h=S.Ys("#path-point-group #path-point-".concat(f+1)),v=K()(i[f],2),p=v[0],x=v[1];p=p*s,x=x*s,h.attr("cx",p).attr("cy",x).attr("display","inline")}r&&Kr(r)}},Mr=function(r){var t=r?M.showGrid:d.current.showGrid;if(t)if(b.current=b.current||S.CRH,b.current.k<1)y.current.select("#grid").attr("display","none");else{var e=or.current,n=e.x,a=e.y,c=e.w,u=e.h,i=b.current.k,l=10*i,s=n*i,f=a*i;y.current.select("#gridPattern").attr("width",l).attr("height",l).attr("x",s).attr("y",f),y.current.select("#grid").attr("display","inline").attr("x",s).attr("y",f).attr("width",c*i).attr("height",u*i)}},Nr=function(r){var t=d.current,e=t.curLabel,n=t.colorBindLabel,a=r||e;if(n){var c=P.current[a]||tt(P.current);D.shapeCommon.stroke=c,D.font.fill=c,r&&(P.current[a]=c)}},Tr=function(r){var t=r||D.shapeCommon.stroke;return S.$_Y(t).copy({opacity:.2})},Fr=function(r,t){var e=S.Ys("#shape-".concat(r));e.attr("stroke",t),d.current.showLabel&&y.current.select("#shape-label-".concat(r)).attr("fill",t),E.current==="shape-"+r&&e.attr("fill",Tr(t))},Kt=function(r){var t,e=d.current,n=e.colorBindLabel,a=e.curLabel;if(n){var c,u,i;if(w.current||!o.current)return;var l=(c=o.current.attr("id"))===null||c===void 0?void 0:c.substring(6),s=(u=m.current)===null||u===void 0?void 0:u[l],f=s.label,h=P.current[a];(i=Object.keys(m.current))===null||i===void 0||i.forEach(function(x){var C=m.current[x].label;C===f&&Fr(x,r)}),h&&(D.shapeCommon.stroke=h,D.font.fill=h),P.current[f]=r,d.current.changeBindColor(P.current);return}if(D.shapeCommon.stroke=r,D.font.fill=r,w.current){var v;(v=w.current)===null||v===void 0||v.forEach(function(x){Fr(x,r)});return}if(o.current){var p=(t=o.current.attr("id"))===null||t===void 0?void 0:t.substring(6);Fr(p,r)}},Rr=function(r,t,e){var n;if(t){var a=(b==null||(n=b.current)===null||n===void 0?void 0:n.k)||1,c=m.current[r],u=c.shape_type,i=c.attrs,l=y.current.select("#shape-label-".concat(r)),s=0,f=0;if(u==="ellipse"){var h=i.cx,v=i.cy,p=i.ry;s=h,f=v-p}else if(u==="rect")s=i.x,f=i.y;else{var x=i.points,C=K()(x[0],2);s=C[0],f=C[1];for(var R=1;R<x.length;R++){var z=K()(x[R],2),U=z[0],X=z[1];f>X?(f=X,s=U):f===X&&s>U&&(s=U)}}s=s*a||0,f=f*a||0,l.attr("x",s).attr("y",f),e&&l.attr("fill",D.font.fill)}},Zr=function(r){var t=r?M.showLabel:d.current.showLabel;if(t){var e=Object.keys(m.current);e==null||e.forEach(function(n){Rr(n,t)})}},sr=function(){for(var r=arguments.length,t=new Array(r),e=0;e<r;e++)t[e]=arguments[e];_.current.push(t),rr.current=[]},Wr=function(){var r=[],t={};if(w.current){var e,n={};(e=w.current)===null||e===void 0||e.forEach(function(i){var l=S.Ys("#shape-".concat(i));t[i]=JSON.parse(JSON.stringify(m.current[i])),n[i]=l}),r=[w.current,t,n]}else if(o.current){var a,c,u=(a=o.current)===null||a===void 0||(c=a.attr("id"))===null||c===void 0?void 0:c.substring(6);t[u]=JSON.parse(JSON.stringify(m.current[u])),r=[o.current,t]}return r},Gr=function(r){var t,e,n,a=(t=o.current)===null||t===void 0||(e=t.attr("id"))===null||e===void 0?void 0:e.substring(6),c=(n=m.current)===null||n===void 0?void 0:n[a],u=c.attrs,i=c.shape_type;if(Y.current=u,i==="polygon"||i==="line"){var l,s;Y.current.boundRect=(l=o.current)===null||l===void 0||(s=l.node())===null||s===void 0?void 0:s.getBBox(),Y.current.close=i==="polygon"}var f=ir(r),h=K()(f,2);Y.current.mx=h[0],Y.current.my=h[1]},ur=function(){var r=Object.keys(m.current),t=[],e=or.current,n=e.x,a=e.y,c=e.scale;return r==null||r.forEach(function(u){var i=m.current[u],l=i.attrs,s=i.label,f=i.shape_type,h=i.hide,v={};if(v.label=s||u,v.shape_type=f,v.attrs={},v.hide=h||!1,v.id=u,f==="rect")v.attrs.x=(l.x-n)*c,v.attrs.y=(l.y-a)*c,v.attrs.width=l.width*c,v.attrs.height=l.height*c;else if(f==="ellipse")v.attrs.cx=(l.cx-n)*c,v.attrs.cy=(l.cy-a)*c,v.attrs.rx=l.rx*c,v.attrs.ry=l.ry*c;else{var p;v.attrs.points=[],(p=l.points)===null||p===void 0||p.forEach(function(x,C){v.attrs.points[C]=[(x[0]-n)*c,(x[1]-a)*c]})}t.push(v)}),t},Zt=function(r){var t=(r==null?void 0:r.target)||(r==null?void 0:r.srcElement),e=S.Ys(t).attr("id"),n=null,a=d.current.drawTool;L.current||O.current?n="crosshair":ar.current&&!N.current&&!A.current||a==="drag"?n="grab":e==="path-add-point"?n="pointer":o.current&&!G.current&&E.current===e||w.current&&w.current.includes(e==null?void 0:e.substring(6))?n="move":(!a||a==="move")&&(n="default"),S.Ys(T.current).style("cursor",n)},Gt=function(r){d.current.showCrosshair&&(y.current.select("#crosshair-v-line").attr("x",r.layerX),y.current.select("#crosshair-h-line").attr("y",r.layerY))},Hr=function(r){var t=S.Ys("#shape-path-group #shape-path-".concat(r));if(t.node())t.attr("display","inline");else{t=S.Ys("#shape-path-group").append("path").attr("id","shape-path-".concat(r)).style("pointer-events","none");var e=D.line;Object.keys(e).forEach(function(n){t.attr(n,e[n])})}return t},jr=function(){var r,t,e=(b==null||(r=b.current)===null||r===void 0?void 0:r.k)||1;(t=w.current)===null||t===void 0||t.forEach(function(n,a){var c=S.Ys("#shape-".concat(n)),u=c.node().getBBox(),i=u.x,l=u.y,s=u.width,f=u.height,h=Hr(a);i=i*e||0,l=l*e||0,s=s*e||0,f=f*e||0;var v=[[i-2,l-2],[i+s+2,l-2],[i+s+2,l+f+2],[i-2,l+f+2]],p=j.current(v);h.attr("d",p+"Z")})},dr=function(){var r,t,e;return(r=w.current)!==null&&r!==void 0&&r.length?w.current:o.current?[(t=o.current)===null||t===void 0||(e=t.attr("id"))===null||e===void 0?void 0:e.substring(6)]:[]},Xr=function(r,t){var e,n,a,c=t,u=r,i="",l="";if(u instanceof Array)w.current=u,c=!0;else if(typeof u=="string")i="shape-"+u,u=y.current.select("#".concat(i));else{var s,f;i=(s=u)===null||s===void 0?void 0:s.attr("id"),l=(f=o.current)===null||f===void 0?void 0:f.attr("id")}if(c&&(l&&i!==l||w.current)){var h,v;if(o.current=null,i=(h=i)===null||h===void 0?void 0:h.substring(6),w.current)if(i){var x=w.current.indexOf(i);if(x>=0){var C;w.current.splice(x,1),(C=w.current)!==null&&C!==void 0&&C.length||(w.current=null)}else w.current.push(i);d.current.changeSelect(dr())}else d.current.changeSelect(dr());else{var p;l=(p=l)===null||p===void 0?void 0:p.substring(6),w.current=[i,l],d.current.changeSelect(dr())}(v=w.current)===null||v===void 0||v.forEach(function(cr,tr){Hr(tr)}),V(),jr();return}o.current=u,(e=S.td_("#shape-path-group *"))===null||e===void 0||e.attr("display","none"),w.current=null;var R=(n=m.current)===null||n===void 0?void 0:n[(a=i)===null||a===void 0?void 0:a.substring(6)],z=R.shape_type,U=R.hide;if(E.current&&S.Ys("#"+E.current).attr("fill",D.shapeCommon.fill),E.current===i)E.current="",(z==="line"||z==="polygon")&&(B.current="",y.current.selectAll("#path-point-group circle,#path-add-point").attr("display","none"),Lr());else if(E.current!==i)if(E.current=i,u.attr("fill",Tr(u.attr("stroke"))),z==="line"||z==="polygon"){var X;if(B.current=i,(X=S.td_("#shape-grip-group"))===null||X===void 0||X.attr("display","none"),U)S.td_("#path-point-group circle,#path-add-point").attr("display","none");else{var Q;(Q=y.current.select("#path-add-point"))===null||Q===void 0||Q.attr("display","inline"),Er()}}else B.current="",y.current.selectAll("#path-point-group circle,#path-add-point").attr("display","none"),Lr();d.current.changeSelect(dr())},kr=function(r){var t,e,n,a=r||o.current;if(a){V();var c=(t=a.attr("id"))===null||t===void 0?void 0:t.substring(6),u=I.current.indexOf(c);I.current.splice(u,1),a==null||a.remove(),(e=y.current.select("#shape-label-".concat(c)))===null||e===void 0||e.attr("display","none"),o.current=null,H.current=null,(n=m.current)===null||n===void 0||delete n[c]}},Ur=function(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,e={};if(w.current){var n,a={};return(n=w.current)===null||n===void 0||n.forEach(function(u){var i=S.Ys("#shape-".concat(u));e[u]=JSON.parse(JSON.stringify(m.current[u])),a[u]=i,kr(i)}),t&&sr("del",w.current,e,a),w.current=null,d.current.changeSize(ur()),d.current.changeSelect(dr()),[e,a]}if(o.current){var c=(r=o.current.attr("id"))===null||r===void 0?void 0:r.substring(6);return e[c]=JSON.parse(JSON.stringify(m.current[c])),t&&sr("del",o.current,e),kr(),d.current.changeSize(ur()),d.current.changeSelect(dr()),[e]}},Ht=function(){var r,t;if(!(!O.current||!o.current)){var e=(r=o.current.attr("id"))===null||r===void 0?void 0:r.substring(6),n=((t=m.current)===null||t===void 0?void 0:t[e])||{},a=n.attrs.points,c=n.shape_type,u=a.length,i={};if(i[e]=JSON.parse(JSON.stringify(m.current[e])),u<=2){sr("del",o.current,i),kr(),V();return}sr("edit",o.current,i),S.Ys("#path-point-group #path-point-".concat(u)).attr("display","none"),S.Ys("#path-point-group #path-point-".concat(O.current)).attr("fill",D.point.fill),a.splice(O.current-1,1),O.current=null;var l=j.current(a);c==="polygon"&&(l+="Z"),o.current.attr("d",l),Rr(e,d.current.showLabel),Er()}},ut=function(r,t){var e=t.shape_type,n=t.attrs;if(e==="rect"||e==="ellipse"){var a=Object.keys(n);a==null||a.forEach(function(i){r.attr(i,n[i])})}else{var c=n.points,u=j.current(c);e==="polygon"&&(u+="Z"),r.attr("d",u)}},ct=function(r){var t=r||[],e=kt()(t),n=e[0],a=e.slice(1),c=K()(a,3),u=c[0],i=c[1],l=c[2],s=[];if(n==="add")u instanceof Array?w.current=u:(w.current=null,o.current=u),s=Ur(!1);else if(n==="del"){if(u instanceof Array)u==null||u.forEach(function(z){var U;I.current.splice(z-1,0,+z),(U=y.current.select("#shape-label-".concat(z)))===null||U===void 0||U.attr("display","inline"),y.current.select("#shape").insert(function(){return l[z].node()})});else{var f,h,v=(f=Object.keys(i))===null||f===void 0?void 0:f[0];I.current.splice(v-1,0,v),(h=y.current.select("#shape-label-".concat(v)))===null||h===void 0||h.attr("display","inline"),y.current.select("#shape").insert(function(){return u.node()})}m.current=Object.assign({},m.current,i)}else if(n==="edit"){var p={};if(u instanceof Array)u==null||u.forEach(function(z){p[z]=JSON.parse(JSON.stringify(m.current[z])),ut(l[z],i[z])}),s=[p,l];else{var x,C,R=(x=u.attr("id"))===null||x===void 0?void 0:x.substring(6);p[R]=JSON.parse(JSON.stringify(m.current[R])),ut(u,(C=Object.values(i))===null||C===void 0?void 0:C[0]),s=[p]}m.current=Object.assign({},m.current,i)}return w.current=null,o.current=null,d.current.changeSize(ur()),d.current.changeSelect([]),V(),Zr(),n==="del"?[u]:[u].concat(er()(s))},Xt=function(){if(_.current.length){var r=_.current.pop(),t=r||[],e=K()(t,1),n=e[0],a=ct(r);if(n==="add"){rr.current.push(["del"].concat(er()(a)));return}else n==="del"?rr.current.push(["add"].concat(er()(a))):n==="edit"&&rr.current.push([n].concat(er()(a)))}},Ut=function(){if(rr.current.length){var r=rr.current.pop(),t=r||[],e=K()(t,1),n=e[0],a=ct(r);if(n==="add")_.current.push(["del"].concat(er()(a)));else if(n==="del"){_.current.push(["add"].concat(er()(a)));return}else n==="edit"&&_.current.push([n].concat(er()(a)))}},lt=function(r,t,e){var n,a=e||o.current;if(a){var c=d.current.showLabel,u=K()(r,2),i=u[0],l=u[1],s=a==null||(n=a.attr("id"))===null||n===void 0?void 0:n.substring(6),f=m.current[s],h=f.attrs,v=f.shape_type,p={};if(v==="rect"){var x=h.x,C=h.y,R=h.width,z=h.height;x+=i,C+=l,a.attr("x",x).attr("y",C),p={x,y:C,width:R,height:z}}else if(v==="ellipse"){var U=h.cx,X=h.cy,Q=h.rx,cr=h.ry;U+=i,X+=l,a.attr("cx",U).attr("cy",X),p={cx:U,cy:X,rx:Q,ry:cr}}else{for(var tr=h.points,hr=v==="polygon",nr=(tr==null?void 0:tr.length)||0,lr=[],fr=0;fr<nr;fr++){var vr=K()(tr[fr],2),Cr=vr[0],pr=vr[1];Cr+=i,pr+=l,lr[fr]=[Cr,pr]}var Yr=j.current(lr);a.attr("d",Yr+(hr?"Z":"")),p={points:lr},lr=null}m.current[s].attrs=p,w.current?jr():v==="rect"||v==="ellipse"?Lr():Er(t),Rr(s,c)}},ot=function(r,t){if(w.current){var e;(e=w.current)===null||e===void 0||e.forEach(function(n){var a=S.Ys("#shape-".concat(n));lt(r,t,a)});return}lt(r,t)},Ir=function(r,t,e){var n=y.current.select("#shape-label-".concat(r)),a=d.current.showLabel;if(n.node()){n.text(t).attr("display","inline"),Rr(r,a,!0);return}var c=y.current.select("#shape-label-group").append("text").attr("id","shape-label-".concat(r)).style("user-select","none").text(t),u=Object.assign({},D.font);e&&(u["text-anchor"]="middle"),Object.keys(u).forEach(function(i){c.attr(i,u[i])}),Rr(r,a)},Sr=function(r){for(var t=arguments.length,e=new Array(t>1?t-1:0),n=1;n<t;n++)e[n-1]=arguments[n];var a=e[0],c=e[1],u=ir(a),i=u[0]-Y.current.mx,l=u[1]-Y.current.my;if(r==="moveGrip"){var s,f,h,v="",p=(s=o.current)===null||s===void 0||(f=s.attr("id"))===null||f===void 0?void 0:f.substring(6),x=(h=m.current)===null||h===void 0?void 0:h[p],C=x.shape_type;L.current?v=L.current.substring(12):v=c.attr("id").substring(12);var R=Bt(C,N.current,v,i,l,Y.current);if(C==="polygon"||C==="line"){var z=j.current(R.points);o.current.attr("d",z+(Y.current.close?"Z":""))}else Object.keys(R).forEach(function(pr){o.current.attr(pr,R[pr])});m.current[p].attrs=R,Lr(),Rr(p,d.current.showLabel);return}if(r==="moveShape"){ot([a.dx,a.dy],a);return}if(r==="moveWhole"){var U,X;b.current=b.current.translate(i,l),S.sPX().transform(y.current,b.current),y.current.selectAll("g.layer").attr("transform",b.current),y.current.selectAll("g#shape-related-group").attr("transform","translate(".concat((U=b.current)===null||U===void 0?void 0:U.x,",").concat((X=b.current)===null||X===void 0?void 0:X.y,")")),Mr()}if(r==="movePoint"){var Q,cr,tr="",hr=(Q=o.current)===null||Q===void 0||(cr=Q.attr("id"))===null||cr===void 0?void 0:cr.substring(6),nr=m.current[hr],lr=nr.attrs.points,fr=nr.shape_type,vr=fr==="polygon";O.current?tr=O.current:tr=c.attr("id").substring(11),lr[tr-1]=u,m.current[hr].attrs={points:lr};var Cr=j.current(lr);o.current.attr("d",Cr+(vr?"Z":"")),Er(a),Rr(hr,d.current.showLabel)}},Qt=function(r){var t=(r==null?void 0:r.target)||(r==null?void 0:r.srcElement),e=S.Ys(t).attr("id"),n=H.current||[],a=n.length;if(S.td_("#path-point-group circle").attr("r",D.point.r),r.type==="touchstart"||r.type==="mouseenter"){if(G.current&&(e!=="path-point-1"||a<3))return;S.Ys("#".concat(e)).attr("r",6),S.Ys(t).style("cursor","pointer")}else S.Ys(t).style("cursor",null)},Qr=function(r,t){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=S.Ys("#path-point-group"),a=n.selectAll("circle"),c=a.size(),u=D.point;if(!c||c<=t){var i=n.append("circle").attr("id",r).call(xr("point",Sr));return i.on("touchstart touchend mouseenter mouseleave",Qt),Object.keys(u).forEach(function(l){i.attr(l,u[l])}),i.attr("display",e?"inline":"none"),i}return S.Ys("#"+r).attr("display",e?"inline":"none")},Vt=function(r){var t,e=ir(r),n=E.current.substring(6),a=(t=m.current)===null||t===void 0?void 0:t[n],c=a.attrs.points,u=a.shape_type,i=c.length,l=-1,s=1/0,f={};f[n]=JSON.parse(JSON.stringify(m.current[n])),sr("edit",o.current,f);for(var h=0;h<i;h++){var v=(h+1)%i,p=c[h],x=c[v],C=Mt(e,p,x);C<s&&(l=v,s=C)}c.splice(l,0,e);var R=j.current(c);u==="polygon"&&(R+="Z"),o.current.attr("d",R);var z="path-point-".concat(i+1);Qr(z,i),Er(r)},st=function(r){var t,e;(t=S.Ys("#path-stretch-line"))===null||t===void 0||t.attr("display","none");var n=o.current.attr("d");r&&o.current.attr("d",n+"Z");var a=(e=o.current.attr("id"))===null||e===void 0?void 0:e.substring("6"),c=d.current,u=c.curLabel,i=c.colorBindLabel;i&&u&&!P.current[u]&&(P.current[u]=D.shapeCommon.stroke,d.current.changeBindColor(P.current)),u=u||a,m.current[a]={shape_type:r?"polygon":"line",label:u,attrs:{points:H.current}},H.current=null,B.current="shape-".concat(a),E.current=B.current,S.Ys("#"+E.current).attr("fill",Tr(o.current.attr("stroke"))),d.current.changeSize(ur()),d.current.changeSelect(dr()),Ir(a,u,!0),y.current.select("#path-add-point").attr("display","inline"),it(a),sr("add",o.current),d.current.endDraw({id:a,label:u})},qt=function(r,t,e,n){var a,c=(r==null?void 0:r.sourceEvent)||r,u=H.current||[],i=u==null?void 0:u.length;if(c.button===2){if(!i)return;i<2?kr():st();return}if(e==="point"&&n.attr("id")==="path-point-1"&&i>=3){st(!0);return}var l=S.Ys("#path-point-group"),s=l.selectAll("circle"),f=s.size(),h=ir(r),v=K()(h,2),p=v[0],x=v[1],C=D.line;if(i){H.current.push([p,x]);var X=j.current(H.current);o.current.attr("d",X)}else{var R;G.current=!0,V(),(R=S.Ys("#path-stretch-line"))===null||R===void 0||R.attr("display","inline"),Nr();var z=Object.assign({},D.shapeCommon,D[t]);o.current=k.current.select("#shape").append(t).call(xr("shape",Sr));var U=br();o.current.attr("id","shape-".concat(U)),Object.keys(z).forEach(function(nr){o.current.attr(nr,z[nr])}),H.current=[[p,x]]}f||(l.append("path").attr("id","path-stretch-line").style("pointer-events","none"),Object.keys(C).forEach(function(nr){S.Ys("#path-stretch-line").attr(nr,C[nr])}));var Q="path-point-".concat(i+1);Qr(Q,i);var cr=(b==null||(a=b.current)===null||a===void 0?void 0:a.k)||1,tr=p*cr,hr=x*cr;S.Ys("#"+Q).attr("cx",tr).attr("cy",hr),Kr(r)},dt=function(r){Zt(r),Gt(r),Kr(r)},$t=function(r,t,e){var n=d.current.drawTool;if(!(!n||t.defaultPrevented)){if(r==="grip"){var a=e.attr("id");L.current&&S.Ys("#"+L.current).attr("fill",D.grip.fill),L.current===a?L.current=null:(L.current=a,e.attr("fill","#ff0"),Gr(t));return}if(L.current){var c=Wr();sr.apply(void 0,["edit"].concat(er()(c))),c=null,Sr("moveGrip",t,e),d.current.changeSize(ur());return}if(r==="point"){var u=e.attr("id").substring(11);O.current&&S.Ys("#path-point-"+O.current).attr("fill",D.point.fill),O.current===u?O.current=null:(O.current=u,e.attr("fill","#ff0"),Gr(t));return}if(O.current){var i=Wr();sr.apply(void 0,["edit"].concat(er()(i))),i=null,Sr("movePoint",t,e),d.current.changeSize(ur());return}if(r==="insertPoint"){Vt(t);return}if(r==="shape"){var l;Xr(e,N.current||(t==null||(l=t.sourceEvent)===null||l===void 0?void 0:l.shiftKey));return}if(r==="whole"){V(),o.current=null,w.current=null,d.current.changeSelect([]);return}}},ft=function(){if(!o.current||!W.current)return!1;W.current=!1,V();var r=It();if(r)return!1;var t=d.current,e=t.drawTool,n=t.curLabel,a=t.colorBindLabel,c=br();a&&n&&!P.current[n]&&(P.current[n]=D.shapeCommon.stroke,d.current.changeBindColor(P.current)),n=n||c,o.current.attr("id","shape-".concat(c)),m.current[c]={shape_type:e,label:n,attrs:H.current},H.current=null,Lr(),d.current.changeSize(ur()),Ir(c,n,e==="ellipse"),sr("add",o.current),d.current.endDraw({id:c,label:n})},_t=function(r){var t=ir(r);W.current=!0,o.current=null,V();var e=K()(t,2);return Y.current.x=e[0],Y.current.y=e[1],S.Ys("#shape-selector").attr("display","inline").attr("x",t[0]).attr("y",t[1]).attr("width",0).attr("height",0),!1},re=function(){var r,t=S.Ys("#shape-selector").node().getBoundingClientRect(),e=Object.keys(m.current),n=[],a=(b==null||(r=b.current)===null||r===void 0?void 0:r.k)||1;e==null||e.forEach(function(c){var u=S.Ys("#shape-".concat(c)),i=n.length,l=S.Ys("#shape-path-group #shape-path-".concat(i)),s=u.node().getBoundingClientRect(),f=s.bottom>t.top&&s.top<t.bottom&&s.left<t.right&&s.right>t.left;if(f){n.push(c);var h=u.node().getBBox(),v=h.x,p=h.y,x=h.width,C=h.height;l.node()?l.attr("display","inline"):l=Hr(i),v=v*a||0,p=p*a||0,x=x*a||0,C=C*a||0;var R=[[v-2,p-2],[v+x+2,p-2],[v+x+2,p+C+2],[v-2,p+C+2]],z=j.current(R);l.attr("d",z+"Z")}else l.node()&&l.attr("display","none")}),w.current=(n==null?void 0:n.length)&&n},te=function(r){var t;if(!W.current)return!1;var e=ir(r),n=Y.current,a=n.x,c=n.y,u=e[0]-a,i=e[1]-c,l=(b==null||(t=b.current)===null||t===void 0?void 0:t.k)||1,s=Math.abs(u),f=Math.abs(i);return u<0&&(a=e[0]),i<0&&(c=e[1]),a=a*l||0,c=c*l||0,s=s*l||0,f=f*l||0,S.Ys("#shape-related-group #shape-selector").attr("x",a).attr("y",c).attr("width",s).attr("height",f),re(),!1},ee=function(){if(!W.current)return!1;W.current=!1,S.td_("#shape-related-group #shape-selector").attr("display","none")},ne=function(r,t,e){var n;return r==="grip"?"moveGrip":r==="point"&&!G.current?"movePoint":r==="insertPoint"?r:t==="drag"||ar.current&&!N.current&&!A.current?"moveWhole":r==="shape"&&!ar.current&&(t==="move"||E.current===e.attr("id")||w.current&&w.current.includes((n=e.attr("id"))===null||n===void 0?void 0:n.substring(6)))?"moveShape":r==="whole"&&t==="move"&&!ar.current&&!A.current?"selectShape":t==="rect"||t==="ellipse"?"shape":t},xr=function(r,t){var e="",n="",a=null,c=!1,u=null;return S.ohM().filter(function(i){return Pr(),e=d.current.drawTool,a=S.Ys(this),n=ne(r,e,a),e?!i.button||i.button===2&&G.current&&n==="path":!1}).on("start",function(i){var l,s;if(i==null||(l=i.sourceEvent)===null||l===void 0||l.stopPropagation(),i==null||(s=i.sourceEvent)===null||s===void 0||s.preventDefault(),Z.current=!1,c=!1,!(L.current||O.current)){if(n==="path"){w.current=null,qt(i,e,r,a);return}if(n==="moveShape"){var f,h,v=(f=a.attr("id"))===null||f===void 0?void 0:f.substring(6);if(!w.current&&E.current!==a.attr("id")||w.current&&!w.current.includes(v)){var p;c=!0,Xr(a,N.current||(i==null||(p=i.sourceEvent)===null||p===void 0?void 0:p.shiftKey))}(A.current||i!=null&&(h=i.sourceEvent)!==null&&h!==void 0&&h.altKey)&&pt()}else if(n.indexOf("move")>=0&&n.length>4){n==="moveWhole"?b.current=b.current||S.CRH:n==="moveGrip"&&Gr(i);var x=ir(i),C=K()(x,2);Y.current.mx=C[0],Y.current.my=C[1]}n.indexOf("move")>=0&&n.length>4&&n!=="moveWhole"&&(u=Wr())}}).on("drag",function(i){var l,s;if(i==null||(l=i.sourceEvent)===null||l===void 0||l.stopPropagation(),i==null||(s=i.sourceEvent)===null||s===void 0||s.preventDefault(),i!=null&&i.sourceEvent&&dt(i.sourceEvent),!(L.current||O.current||n==="path"||n==="insertPoint")&&!(i.dx===0&&i.dy===0)){if(Z.current=!0,n.indexOf("move")>=0){t(n,i,a);return}if(n==="shape"){W.current?ie(i,e):(w.current=null,ae(i,e));return}n==="selectShape"&&(W.current?te(i):_t(i))}}).on("end",function(i){var l,s;if(i==null||(l=i.sourceEvent)===null||l===void 0||l.stopPropagation(),i==null||(s=i.sourceEvent)===null||s===void 0||s.preventDefault(),Z.current)if(n==="shape"){ft(),d.current.changeSelect(dr());return}else if(n==="selectShape"){ee(),d.current.changeSelect(dr());return}else n!=="moveWhole"&&n.indexOf("move")>=0&&n.length>4&&(d.current.changeSize(ur()),u&&sr.apply(void 0,["edit"].concat(er()(u))),u=null);else if(G.current&&n==="path")H.current||(G.current=!1);else if(!c){$t(r,i,a);return}})},Vr=function(r){var t,e="",n=e.drawTool;return S.sPX().scaleExtent((t=d.current)===null||t===void 0?void 0:t.scaleExtent).filter(function(a){return(!a.ctrlKey||a.type==="wheel")&&!a.button}).on("start",function(a){var c,u;n=d.current.drawTool,Pr(),a==null||(c=a.sourceEvent)===null||c===void 0||c.stopPropagation(),a==null||(u=a.sourceEvent)===null||u===void 0||u.preventDefault()}).on("zoom",function(a){var c,u;a==null||(c=a.sourceEvent)===null||c===void 0||c.stopPropagation(),a==null||(u=a.sourceEvent)===null||u===void 0||u.preventDefault(),n&&r&&r(a)}).on("end",function(a){var c,u;a==null||(c=a.sourceEvent)===null||c===void 0||c.stopPropagation(),a==null||(u=a.sourceEvent)===null||u===void 0||u.preventDefault()})},vt=function(r){var t,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;e&&(b.current=r.transform),y.current.selectAll("g.layer").attr("transform",b.current),y.current.selectAll("g#shape-related-group").attr("transform","translate(".concat(b.current.x,", ").concat(b.current.y,")")),(t=w.current)!==null&&t!==void 0&&t.length?jr():(Lr(),e?Er(r):Er()),Zr(),Mr(),$.current=b.current.k,d.current.changeScale($.current)},ht=function(r){var t,e,n=!0,a=r;if(!a){var c;a=o.current,a.attr("fill",D.shapeCommon.fill),n=!1,(c=y.current.select("#path-add-point"))===null||c===void 0||c.attr("display","inline")}var u=(t=a.attr("id"))===null||t===void 0?void 0:t.substring(6),i=m.current[u],l=i.label,s=i.shape_type,f=a.clone(),h=br();return f=k.current.select("#shape").append(function(){return f.node()}).attr("id","shape-".concat(h)).call(xr("shape",Sr)),m.current[h]=JSON.parse(JSON.stringify((e=m.current)===null||e===void 0?void 0:e[u])),Ir(h,l,s!=="rect"),n?""+h:(f.attr("fill",Tr(f.attr("stroke"))),E.current="shape-".concat(h),f)},pt=function(){if(w.current){var r,t=[];(r=w.current)===null||r===void 0||r.forEach(function(e){var n=S.Ys("#shape-".concat(e));t.push(ht(n))}),w.current=t,d.current.changeSelect(dr()),sr("add",w.current);return}o.current&&(o.current=ht(),d.current.changeSelect(dr()),sr("add",o.current))},ae=function(r,t){var e=ir(r);W.current=!0,o.current=k.current.select("#shape").append(t).call(xr("shape",Sr)),Nr();var n=Object.assign({},D.shapeCommon,D[t]),a="x",c="y";t==="ellipse"&&(a="cx",c="cy");var u=K()(e,2);Y.current.x=u[0],Y.current.y=u[1];var i=K()(e,2);return n[a]=i[0],n[c]=i[1],Object.keys(n).forEach(function(l){o.current.attr(l,n[l])}),!1},ie=function(r,t){if(!o.current||!W.current)return!1;var e=ir(r),n=Y.current,a=n.x,c=n.y,u=e[0]-a,i=e[1]-c;if(t==="rect"){var l=Math.abs(u),s=Math.abs(i);return u<0&&(N.current&&l<s?a=a-s:a=e[0]),i<0&&(N.current&&l>s?c=c-l:c=e[1]),N.current&&(l>s?s=l:l=s),H.current={x:a,y:c,width:l,height:s},o.current.attr("x",a).attr("y",c).attr("width",l).attr("height",s),!1}if(t==="ellipse"){var f=u/2||0,h=i/2||0,v=Math.abs(f),p=Math.abs(h);N.current&&(v>p?(h=h>0?v:-v,p=v):(f=f>0?p:-p,v=p)),a=a+f,c=c+h,H.current={cx:a,cy:c,rx:v,ry:p},o.current.attr("cx",a).attr("cy",c).attr("rx",v).attr("ry",p)}return!1},ue=function(r){if(r!=="path"&&G.current){kr(),G.current=!1;return}},ce=function(){if(W.current){ft();return}},le=function(r){ar.current=r.ctrlKey,A.current=r.altKey,N.current=r.shiftKey;var t=r.keyCode||r.which||r.charCode;if(G.current){t===27&&kr();return}if(t===8||t===46){O.current?(Ht(),d.current.changeSize(ur())):Ur();return}if(ar.current&&t===67){var e;yr.current=w.current&&er()(w.current)||((e=o.current)===null||e===void 0?void 0:e.attr("id"))||null}if(ar.current&&t===86){if(!yr.current)return;V();var n=Lt()(yr.current)==="object";n?w.current=er()(yr.current):o.current=S.Ys("#".concat(yr.current)),pt(),n?jr():["rect","ellipse"].includes(m.current[yr.current.substring(6)].shape_type)?Lr():Er(),d.current.changeSize(ur())}if([37,38,39,40].includes(t)){var a=0,c=0;t===37?a=-1:t===38?c=-1:t===39?a=1:t===40&&(c=1);var u=Wr();sr.apply(void 0,["edit"].concat(er()(u))),u=null,ot([a,c],r)}},oe=function(r){ar.current=r.ctrlKey,A.current=r.altKey,N.current=r.shiftKey},gt=function(r){r?S.Ys("body").on("keyup",oe):(S.Ys("body").on("keyup",null),ar.current=!1,A.current=!1,N.current=!1,ce())},se=function(){var r;(r=S.Ys(T.current).select("div>svg"))===null||r===void 0||r.remove(),y.current=S.Ys(T.current).selectChild("div").append("svg").attr("id","svgroot");var t=y.current.append("defs"),e=t.append("pattern").attr("id","gridPattern").attr("patternUnits","userSpaceOnUse").attr("x",0).attr("y",0).attr("width","10").attr("height","10"),n=e.append("rect");n.attr("fill","none").attr("stroke","#787878").attr("stroke-width","0.5").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%"),k.current=y.current.append("svg").attr("id","svgcont"),k.current.append("g").attr("class","layer").attr("id","img").style("pointer-events","none"),k.current.append("g").attr("class","layer").attr("id","shape");var a=y.current.append("g").attr("id","shape-related-group"),c=a.append("rect").attr("id","shape-selector").attr("display","none").style("pointer-events","none"),u=Object.assign({},D.rect,D.selectBox);Object.keys(u).forEach(function(p){c.attr(p,u[p])});var i=a.append("path").attr("id","path-add-point").attr("display","none"),l=D.pathAddPoint;Object.keys(l).forEach(function(p){i.attr(p,l[p])}),a.append("g").attr("class","grip-layer").attr("id","shape-grip-group").attr("display","none"),S.Ys("#shape-grip-group").append("path").attr("id","resize-path").style("pointer-events","none");var s=D.line;Object.keys(s).forEach(function(p){S.Ys("#resize-path").attr(p,s[p])});for(var f=0;f<8;f++)S.Ys("#shape-grip-group").append("rect").attr("id","resize-grip-"+et[f]).style("cursor",et[f]+"-resize");var h=D.grip;Object.keys(h).forEach(function(p){S.td_("#shape-grip-group rect").attr(p,h[p])}),a.append("g").attr("class","point_layer").attr("id","path-point-group"),a.append("g").attr("class","path_layer").attr("id","shape-path-group").style("pointer-events","none"),a.append("g").attr("class","label_layer").attr("id","shape-label-group").attr("display","none").style("pointer-events","none"),a.append("rect").attr("id","grid").attr("display","none").style("pointer-events","none").attr("x",0).attr("y",0).attr("width","0").attr("height","0").attr("fill","url(#gridPattern)").attr("stroke","none");var v=y.current.append("g").attr("class","crosshair_layer").style("pointer-events","none").attr("display","none");v.append("rect").attr("id","crosshair-v-line").attr("width",.5).attr("height","100%"),v.append("rect").attr("id","crosshair-h-line").attr("width","100%").attr("height",.5),v.selectAll("rect").attr("x",0).attr("y",0).attr("fill","#00f").attr("stroke","none")},Br=function(){var r=T.current.getBoundingClientRect(),t=r.right-r.left||D.svg.width,e=r.bottom-r.top||D.svg.height,n=[t,e];D.svg.width=n[0],D.svg.height=n[1],S.Ys("#svgcanvas").style("width",t+"px").style("height",e+"px"),S.td_("#svgroot,#svgcont").attr("width",t).attr("height",e)},de=function(){y.current.on("mousemove touchmove",dt).call(xr("whole",Sr)).call(Vr(function(r){vt(r)})).on("dblclick.zoom",null),S.td_("#shape-grip-group rect").call(xr("grip",Sr)),y.current.select("#path-add-point").call(xr("insertPoint",Sr))},fe=function(){j.current=S.jvg(),se(),Br(),de(),qr(d.current.showCrosshair)},yt=function(){y.current.selectAll("g.layer,g#shape-related-group").attr("transform",null),b.current=null,y.current.call(Vr().transform,S.CRH),d.current.changeScale("1")},St=function(){var r,t,e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;_.current=[],rr.current=[],V(),o.current&&(o.current=null),w.current&&(w.current=null),m.current={},e&&d.current.changeSize(ur()),I.current=[],d.current.changeSelect([]),(r=y.current.selectAll("#shape *"))===null||r===void 0||r.remove(),(t=y.current.selectAll("#shape-label-group *"))===null||t===void 0||t.attr("display","none")},ve=function(){var r,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;(r=k.current.select("g#img").select("image"))===null||r===void 0||r.remove(),St(t),yt()},he=function(r){var t,e,n=m.current[r].hide,a=(t=o.current)===null||t===void 0||(e=t.attr("id"))===null||e===void 0?void 0:e.substring(6);if(n=!n,m.current[r].hide=n,y.current.selectAll("g#shape #shape-".concat(r,",#shape-label-").concat(r)).attr("display",n?"none":"inline"),w.current&&w.current.includes(r)){var c,u=w.current.indexOf(r);if(w.current.splice(u,1),!((c=w.current)!==null&&c!==void 0&&c.length))w.current=null,S.td_("#shape-path-group *").attr("display","none"),d.current.changeSelect([]);else{var i;(i=S.Ys("#shape-path-".concat(w.current.length)))===null||i===void 0||i.attr("display","none"),jr(),d.current.changeSelect(dr())}}else a&&a===r&&(V(),o.current=null,d.current.changeSelect([]));d.current.changeSize(ur())},mt=function(r){return r?(Br(),new Promise(function(t){var e=new Image;e.onload=function(n){var a,c,u=n.target.width,i=n.target.height,l=u,s=i,f=0,h=0,v=1,p=D.svg,x=p.width,C=p.height,R=x/C,z=u/i;R>z?(s=C,l=s*z,v=i/s):(l=x,s=l/z,v=u/l),f=(x-l)/2,h=(C-s)/2,or.current={x:f,y:h,scale:v,w:l,h:s},(a=k.current.select("g#img").select("image"))===null||a===void 0||a.remove(),(c=k.current.select("g#img").append("image").attr("width",l).attr("height",s).attr("x",f).attr("y",h).attr("xlink:href",r).attr("draggable","false"))===null||c===void 0||c.style("filter",wr.current),Mr(),d.current.imgLoaded({width:u,height:i}),t(!0)},e.src=r})):!1},pe=function(r){if(r){var t=Object.keys(m.current);t==null||t.forEach(function(e){var n=y.current.select("#shape-".concat(e));y.current.select("#shape-label-".concat(e)).attr("fill",n.attr("stroke"))})}},ge=function(r){y.current.select("#grid").attr("display",r&&(!b.current||b.current.k>=1)?"inline":"none"),Mr(!0)},qr=function(r){y.current.select(".crosshair_layer").attr("display",r&&M.drawTool!=="move"&&M.drawTool!=="drag"?"inline":"none")},ye=function(r){var t;wr.current=r,(t=k.current.select("#img image"))===null||t===void 0||t.style("filter",r)},Se=function(r){y.current.select("#shape-label-group").attr("display",r?"inline":"none"),Zr(!0),pe(r)},me=function(r,t){if(m.current[r]){m.current[r].label=t,y.current.select("#shape-label-".concat(r)).text(t),d.current.changeSize(ur());var e=d.current,n=e.colorBindLabel,a=e.curLabel;if(n){var c="",u=P.current[t];a?c=P.current[t]||tt(P.current):c=D.shapeCommon.stroke,Fr(r,c),u||(P.current[t]=c,d.current.changeBindColor(P.current))}}},be=function(r){var t=+$.current,e=0,n=d.current.scaleExtent;isNaN(r)?r==="enlarge"?(e=(n[1]-t)/20,e=e>.1?e:.2,t=t+e):r==="narrow"&&(e=(t-n[0])/5,t=t-e):t=+r,t=t<n[0]?n[0]:t,t=t>n[1]?n[1]:t,Vr().scaleTo(y.current,t),b.current=S.P2S(y.current.node()),vt(b.current,!1)},we=function(r){if(!r||!(r!=null&&r.length))return[];var t=[];try{t=r.map(function(e){var n;if(!(e!=null&&e.attrs))return e;var a=e.attrs,c=e.shape_type,u=rt()(e,Nt);if(c.indexOf("rect")>=0){var i=a,l=i.x,s=i.y,f=i.width,h=i.height;return a=[[l,s],[l+f,s+h]],gr()({points:a,shape_type:"rectangle"},u)}else if(c==="ellipse"){var v=a,p=v.cx,x=v.cy,C=v.rx,R=v.ry;return C===R?(a=[[p,x],[p,x+R]],gr()({points:a,shape_type:"circle"},u)):(a=[[p,x],[p,x+R],[p+C,x]],gr()({points:a,shape_type:"ellipse"},u))}return gr()({points:(n=a)===null||n===void 0?void 0:n.points,shape_type:c},u)})}catch(e){console.error(e.toString())}return t},xe=function(r){if(!r||!(r!=null&&r.length))return[];var t=[];try{t=r.map(function(e,n){var a;if(e=gr()(gr()({},e),{},{id:"".concat(n+1)}),(a=e)!==null&&a!==void 0&&a.attrs)return e;var c=e,u=c.points,i=c.shape_type,l=rt()(c,Tt);if(i.indexOf("rect")>=0){var s=u,f=K()(s,2),h=K()(f[0],2),v=h[0],p=h[1],x=K()(f[1],2),C=x[0],R=x[1],z=Math.abs(C-v),U=Math.abs(R-p),X=v,Q=p;return X>C&&(X=C),Q>R&&(Q=R),u={x:X,y:Q,width:z,height:U},gr()({attrs:u,shape_type:"rect"},l)}else if(i==="circle"){var cr=u,tr=K()(cr,2),hr=K()(tr[0],2),nr=hr[0],lr=hr[1],fr=K()(tr[1],2),vr=fr[0],Cr=fr[1],pr=Math.sqrt(Math.pow(vr-nr,2)+Math.pow(Cr-lr,2));return u={cx:nr,cy:lr,rx:pr,ry:pr},gr()({attrs:u,shape_type:"ellipse"},l)}else if(i==="ellipse"){var Yr=u,Ar=K()(Yr,3),zr=K()(Ar[0],2),Or=zr[0],bt=zr[1],Re=K()(Ar[1],2),Ye=Re[1],ke=K()(Ar[2],1),De=ke[0],je=Ye-bt,Be=De-Or;return u={cx:Or,cy:bt,rx:Be,ry:je},gr()({attrs:u,shape_type:"ellipse"},l)}else if(i==="polygon")return gr()({attrs:{points:u},shape_type:i},l);return gr()({attrs:{points:u},shape_type:"line"},l)})}catch(e){console.error(e.toString())}return t},Ce=function(r,t,e,n,a){I.current.push(r),m.current[r]={label:e,shape_type:t,hide:n,attrs:a},e&&Ir(r,e,t!=="rect"),y.current.selectAll("g#shape #shape-".concat(r,",#shape-label-").concat(r)).attr("display",n?"none":"inline")},Ee=function(r){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!(!r||!(r!=null&&r.length)))try{var e=or.current,n=e.x,a=e.y,c=e.scale,u=k.current.select("#shape");r.forEach(function(i){var l=i.attrs,s=i.id,f=i.hide,h=i.label,v=i.shape_type,p=null,x=null;if(v==="rect"||v==="ellipse"){var C,R=Dr(v),z=l[R.x],U=l[R.y],X=l[R.w],Q=l[R.h];if(!+X||!+Q)return;s||(s=br()),p=u.append(v).attr("id","shape-".concat(s)).call(xr("shape",Sr)),Nr(h);var cr=Object.assign({},D.shapeCommon,D[v]);Object.keys(cr).forEach(function(Or){p.attr(Or,cr[Or])}),z=+z/c+n,U=+U/c+a,X=X/c,Q=Q/c,p.attr(R.x,z).attr(R.y,U).attr(R.w,X).attr(R.h,Q),x=(C={},Jr()(C,R.x,z),Jr()(C,R.y,U),Jr()(C,R.w,X),Jr()(C,R.h,Q),C)}else{s||(s=br()),Nr(h);var tr=l.points,hr=tr.length,nr=u.append("path").attr("id","shape-".concat(s)).call(xr("shape",Sr)),lr=Object.assign({},D.shapeCommon,D.path),fr=[];Object.keys(lr).forEach(function(Or){nr.attr(Or,lr[Or])});for(var vr=0;vr<hr;vr++){var Cr=K()(tr[vr],2),pr=Cr[0],Yr=Cr[1];pr=+pr/c+n,Yr=+Yr/c+a,fr[vr]=[pr,Yr];var Ar="path-point-".concat(vr+1);Qr(Ar,vr,!1)}var zr=j.current(fr);v==="polygon"&&(zr+="Z"),nr.attr("d",zr),x={points:fr}}i.id=s,Ce(s,v,h,f,x)}),d.current.changeBindColor(P.current),t&&d.current.changeSize(r)}catch(i){console.error(i.toString())}},Oe=function(){return _.current.length>0},Pe=function(){return rr.current.length>0},Le=function(r){r&&!T.current&&(T.current=r)};return(0,J.useEffect)(function(){return T.current&&(fe(),window.addEventListener("resize",Br)),function(){S.Ys("body").on("keyup",null),window.removeEventListener("resize",Br)}},[]),(0,J.useEffect)(function(){M.src!==d.current.src&&mt(M.src),M.drawTool!==d.current.drawTool&&(ue(M.drawTool),qr(M.showCrosshair)),M.showLabel!==d.current.showLabel&&Se(M.showLabel),M.showGrid!==d.current.showGrid&&ge(M.showGrid),M.showCrosshair!==d.current.showCrosshair&&qr(M.showCrosshair),d.current=M},[M]),(0,J.useImperativeHandle)(F,function(){return{reload:ve,zoomReload:yt,loadImg:mt,clearShape:St,toggleShape:he,getMarkData:ur,selectShape:Xr,delSelectShape:Ur,getSelectIds:dr,editLabel:me,adjustImg:ye,undoSvg:Xt,canUndo:Oe,redoSvg:Ut,canRedo:Pe,changeScale:be,changeColor:Kt,drawShapeFromSize:Ee,setCanvasSize:Br,convertToPoints:we,convertToAttrs:xe}}),(0,mr.jsxs)("div",{ref:Le,className:"w-draw-container ".concat(d.current.className||""),onKeyDown:le,children:[(0,mr.jsx)("div",{id:"svgcanvas",className:"w-svg-box",tabIndex:-1,onFocus:function(){return gt(!0)},onBlur:function(){return gt(!1)}}),M==null?void 0:M.children]})});nt.defaultProps={src:"",curLabel:"",showLabel:!1,showGrid:!1,showCrosshair:!1,minSize:[4,4],drawTool:"",scaleExtent:[.02,30],colorBindLabel:!0,changeSize:function(){},changeBindColor:function(){},changeSelect:function(){},changeScale:function(){},imgLoaded:function(){},endDraw:function(){}};var Ft=nt,at=function(F){var d=F.shapeList,T=F.selectShapeIds,y=F.delFunc,k=F.selectFunc,o=F.leftRender,E=F.rightRender,B=F.topRender,L=F.title,O=F.className,j=(0,J.useRef)(null),b=(0,J.useState)([]),Y=K()(b,2),W=Y[0],G=Y[1],Z=(0,J.useRef)(-1),I=(0,J.useRef)(-1);(0,J.useEffect)(function(){G(T)},[T]);var $=function(){I.current=-1,Z.current=-1;var A=d.length,m=T==null?void 0:T.length;if(!(!A||!m)){var H=er()(T);H.sort(function(rr,V){return rr-V});for(var P=0;P<A;P++){var _=d[P].id;_===H[0]&&(Z.current=P),_===H[m-1]&&(I.current=P)}}},or=function(A){A?(j.current.classList.add("box-active"),$()):j.current.classList.remove("box-active")},w=function(A){k&&(A.length===1?k(A[0]):k(A))},yr=function(A){var m=A.keyCode||A.which||A.charCode;if(m===8||m===46){A==null||A.stopPropagation(),y&&y();return}if(A.ctrlKey&&m===65){A==null||A.stopPropagation();var H=d==null?void 0:d.map(function(V){return V==null?void 0:V.id});G(er()(H)),w(H),I.current=d.length-1,Z.current=0;return}var P=-1,_=d.length-1;if(m===38&&(Z.current>0||W.length>1)?(P=Z.current-1,P=P<0?0:P):m===40&&(I.current<_||W.length>1)&&(P=I.current+1,P=P>_?_:P),P!==-1){var rr;A==null||A.stopPropagation(),W=[(rr=d[P])===null||rr===void 0?void 0:rr.id],G(W),w(W),I.current=P,Z.current=P}},wr=function(A,m,H){H.stopPropagation();var P=er()(W),_=P.indexOf(A);if(H.shiftKey){m<=Z.current?Z.current=m:I.current=m,Z.current=Z.current<0?0:Z.current,P=[];for(var rr=Z.current;rr<=I.current;rr++){var V;P.push((V=d[rr])===null||V===void 0?void 0:V.id)}}else if(H.ctrlKey)if(_>=0){if(P.length===1)Z.current=-1,I.current=-1;else if(m===Z.current)for(var Pr=Z.current+1;Pr<=I.current;Pr++){var ir;if(P.includes((ir=d[Pr])===null||ir===void 0?void 0:ir.id)){Z.current=Pr;break}}else if(m===I.current)for(var br=I.current-1;br>=Z.current;br--){var Dr;if(P.includes((Dr=d[br])===null||Dr===void 0?void 0:Dr.id)){I.current=br;break}}P.splice(_,1)}else P.push(A),m<Z.current&&(Z.current=m),m>I.current&&(I.current=m);else P=[A],I.current=m,Z.current=m;G(P),w(P)},ar=function(){W.length&&(G([]),w([]),I.current=-1,Z.current=-1)};return(0,mr.jsxs)("div",{className:"win-box ".concat(O),children:[(0,mr.jsxs)("div",{className:"w-head",children:[L||"\u56FE\u5F62\u5217\u8868",(0,mr.jsx)("div",{className:"flex-center",children:B&&B()})]}),(0,mr.jsx)("div",{className:"w-box w-box-overflow",ref:j,tabIndex:-1,onFocus:function(){return or(!0)},onBlur:function(){return or(!1)},onClick:ar,onKeyDown:yr,children:d&&d.map(function(N,A){var m=N==null?void 0:N.id;return(0,mr.jsxs)("div",{className:"list-item ".concat(W.includes(m)?"on":""),onClick:function(P){return wr(m,A,P)},children:[o&&o(N,A),(0,mr.jsx)("p",{className:"list-txt",title:N==null?void 0:N.label,children:N==null?void 0:N.label}),E&&E(N,A)]},A)})})]})};at.defaultProps={className:"",title:"",shapeList:[],selectShapeIds:[],leftRender:null,rightRender:null,topRender:null,delFunc:function(){},selectFunc:function(){}};var Wt=at}}]);
